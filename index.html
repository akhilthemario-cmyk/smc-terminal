<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SMC Terminal â€” Live ICT/SMC AI Analyst</title>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=DM+Mono:ital,wght@0,300;0,400;0,500;1,400&family=Instrument+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg0:#04040a;--bg1:#070710;--bg2:#0a0a16;--bg3:#0d0d1e;--bg4:#12122a;--accent:#6c5ce7;--accent2:#00cec9;--red:#ff4757;--green:#00d4aa;--yellow:#ffa502;--blue:#4da6ff;--text1:#e8e6f2;--text2:#8886a0;--text3:#4e4c64;--border:rgba(108,92,231,.1);--border2:rgba(108,92,231,.22)}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Manrope',sans-serif;background:var(--bg0);color:var(--text1);overflow:hidden;height:100vh}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(108,92,231,.2);border-radius:2px}
@keyframes fadeUp{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:.3}50%{opacity:1}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes slideR{from{opacity:0;transform:translateX(16px)}to{opacity:1;transform:translateX(0)}}
@keyframes breathe{0%,100%{box-shadow:0 0 6px rgba(108,92,231,.15)}50%{box-shadow:0 0 16px rgba(108,92,231,.35)}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
.fade-up{animation:fadeUp .25s ease-out backwards}
.hover-row:hover{background:rgba(108,92,231,.06)!important}.hover-row{transition:background .1s;cursor:pointer}
#app{display:flex;flex-direction:column;height:100vh}
#topbar{height:42px;min-height:42px;background:var(--bg1);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 10px;gap:6px;z-index:100}
#workspace{flex:1;display:flex;overflow:hidden}
#chart-col{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative}
#chart-wrap{flex:1;overflow:hidden;position:relative}
#ai-watcher{height:210px;min-height:210px;background:var(--bg1);border-top:1px solid var(--border2);display:flex;flex-direction:column;overflow:hidden;position:relative}
#ai-watcher::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),var(--accent2),transparent);opacity:.4}
#right-panel{width:360px;min-width:360px;background:var(--bg2);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
#statusbar{height:20px;min-height:20px;background:var(--bg0);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 10px;font-size:8px;color:var(--text3);font-family:'DM Mono',monospace}
.logo{display:flex;align-items:center;gap:6px;margin-right:4px}
.logo-i{width:24px;height:24px;border-radius:5px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;color:#fff}
.logo-t{font-size:11px;font-weight:700;font-family:'Instrument Sans',sans-serif}
.logo-s{font-size:7px;color:var(--accent);letter-spacing:1px;margin-top:-1px}
.sep{width:1px;height:20px;background:var(--border);margin:0 2px}
.tb{padding:3px 9px;border-radius:4px;border:1px solid var(--border);background:rgba(108,92,231,.03);color:var(--text1);font-size:10px;font-weight:600;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:4px;transition:all .1s;white-space:nowrap}
.tb:hover{background:rgba(108,92,231,.07);border-color:var(--border2)}
.tfb{display:flex;gap:1px;background:rgba(108,92,231,.02);border-radius:4px;padding:1px}
.tf{padding:2px 6px;border-radius:3px;border:none;background:transparent;color:var(--text3);font-size:8px;font-weight:500;cursor:pointer;font-family:'DM Mono',monospace;transition:all .08s}
.tf.on{background:rgba(108,92,231,.18);color:#b8a9ff}.tf:hover{color:var(--text2)}
.sess{display:flex;align-items:center;gap:4px;padding:2px 8px;border-radius:4px;background:rgba(108,92,231,.02);border:1px solid var(--border);font-size:8px;font-weight:600}
.kzt{font-size:6px;background:rgba(0,212,170,.1);color:var(--green);padding:1px 3px;border-radius:2px;font-weight:800}
.abtn{padding:3px 12px;border-radius:4px;border:none;background:linear-gradient(135deg,var(--accent),#7c5cff);color:#fff;font-size:9px;font-weight:700;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:4px;transition:all .12s}
.abtn:hover{filter:brightness(1.1);transform:translateY(-1px)}.abtn:disabled{opacity:.4;cursor:wait}
.autob{padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:rgba(108,92,231,.02);color:var(--text2);font-size:8px;font-weight:700;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:4px;transition:all .1s}
.autob.on{border-color:rgba(0,212,170,.25);background:rgba(0,212,170,.05);color:var(--green)}
.adot{width:4px;height:4px;border-radius:50%;background:var(--text3)}.autob.on .adot{background:var(--green);animation:pulse 1.5s infinite}
.nbtn{width:28px;height:28px;border-radius:5px;border:1px solid var(--border);background:rgba(108,92,231,.02);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;position:relative}
.ncnt{position:absolute;top:-2px;right:-2px;min-width:13px;height:13px;border-radius:50%;background:var(--red);color:#fff;font-size:7px;font-weight:800;display:flex;align-items:center;justify-content:center;padding:0 2px}
.sdrop{position:absolute;top:36px;left:0;width:220px;background:var(--bg3);border:1px solid var(--border2);border-radius:7px;z-index:999;box-shadow:0 12px 40px rgba(0,0,0,.6);overflow:hidden;display:none}.sdrop.open{display:block}
.ssinp{width:100%;padding:7px 9px;border:none;border-bottom:1px solid var(--border);background:transparent;color:var(--text1);font-size:10px;outline:none;font-family:inherit}
.slist{max-height:240px;overflow-y:auto}
.si{padding:6px 10px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(108,92,231,.03);font-size:10px}.si.act{background:rgba(108,92,231,.1)}
.aw-head{display:flex;align-items:center;justify-content:space-between;padding:5px 10px;border-bottom:1px solid var(--border);background:var(--bg1)}
.aw-title{display:flex;align-items:center;gap:5px;font-size:9px;font-weight:700;font-family:'Instrument Sans',sans-serif}
.aw-eye{width:18px;height:18px;border-radius:4px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:9px;animation:breathe 3s infinite}
.aw-status{display:flex;align-items:center;gap:4px;font-size:7px;font-weight:600}
.aw-live{width:5px;height:5px;border-radius:50%;background:var(--green);animation:blink 2s infinite}
.aw-feed{flex:1;overflow-y:auto;padding:4px 8px}
.aw-msg{display:flex;gap:5px;margin-bottom:4px;animation:fadeUp .2s ease-out}
.aw-ts{font-size:7px;color:var(--text3);font-family:'DM Mono',monospace;min-width:34px;margin-top:2px}
.aw-ico{font-size:10px;margin-top:1px}
.aw-txt{font-size:8.5px;line-height:1.4;color:var(--text2);flex:1}
.aw-txt strong{color:var(--text1);font-weight:600}
.aw-txt .g{color:var(--green);font-weight:700}.aw-txt .r{color:var(--red);font-weight:700}.aw-txt .a{color:var(--accent);font-weight:600}.aw-txt .y{color:var(--yellow);font-weight:600}.aw-txt .b{color:var(--blue);font-weight:600}
.aw-alert{padding:4px 7px;border-radius:4px;margin-bottom:4px;border:1px solid;display:flex;gap:5px;align-items:flex-start;animation:slideR .3s ease-out}
.aw-alert.buy{background:rgba(0,212,170,.04);border-color:rgba(0,212,170,.18)}
.aw-alert.sell{background:rgba(255,71,87,.04);border-color:rgba(255,71,87,.18)}
.aw-alert.info{background:rgba(108,92,231,.04);border-color:rgba(108,92,231,.15)}
.ptabs{display:flex;border-bottom:1px solid var(--border);background:var(--bg1)}
.ptab{flex:1;padding:8px 3px;font-size:8px;font-weight:700;text-align:center;cursor:pointer;border:none;background:none;color:var(--text3);border-bottom:2px solid transparent;font-family:inherit;transition:all .1s;letter-spacing:.2px}
.ptab:hover{color:var(--text2);background:rgba(108,92,231,.04)}.ptab.on{color:#b8a9ff;border-bottom-color:var(--accent);background:rgba(108,92,231,.03)}
.tbadge{margin-left:2px;background:var(--red);color:#fff;font-size:6px;padding:1px 3px;border-radius:2px;font-weight:800}
.pbody{flex:1;overflow-y:auto;padding:8px}
.bcard{border-radius:7px;padding:10px;margin-bottom:7px}
.bcard.bull{background:rgba(0,212,170,.03);border:1px solid rgba(0,212,170,.12)}.bcard.bear{background:rgba(255,71,87,.03);border:1px solid rgba(255,71,87,.12)}
.tcard{background:rgba(108,92,231,.02);border:1px solid var(--border);border-radius:7px;padding:10px;margin-bottom:7px}
.dcard{padding:6px 7px;margin-bottom:3px;border-radius:5px;border:1px solid var(--border);display:flex;gap:5px;align-items:flex-start;font-size:8px}
.dcard.critical{background:rgba(255,71,87,.03);border-color:rgba(255,71,87,.12)}.dcard.high{background:rgba(108,92,231,.03);border-color:rgba(108,92,231,.08)}.dcard.medium{background:rgba(20,20,40,.25)}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:4px}
.sc{padding:4px 5px;border-radius:4px;background:rgba(0,0,0,.18);text-align:center}
.sl{font-size:7px;color:var(--text3);text-transform:uppercase;letter-spacing:.4px}
.sv{font-size:10px;font-weight:700;font-family:'DM Mono',monospace;margin-top:1px}
.sigcard{padding:8px;margin-bottom:5px;border-radius:6px;border:1px solid var(--border);animation:fadeUp .25s ease-out backwards}
.sigcard.unread{background:rgba(108,92,231,.04);border-color:var(--border2)}.sigcard.read{background:rgba(12,12,24,.3)}
.g4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:3px}
.cmsg{margin-bottom:8px;animation:fadeUp .2s ease-out}
.cbub{padding:7px 9px;border-radius:6px;font-size:9px;line-height:1.55}
.cbub.usr{background:rgba(77,166,255,.05);border:1px solid rgba(77,166,255,.08);color:#a5c8f0}
.cbub.ai{background:rgba(108,92,231,.03);border:1px solid rgba(108,92,231,.06);color:var(--text2)}
.cinw{padding:5px 8px;border-top:1px solid var(--border);display:flex;gap:5px}
.cinp{flex:1;padding:6px 7px;border-radius:5px;border:1px solid var(--border);background:rgba(108,92,231,.02);color:var(--text1);font-size:8px;outline:none;font-family:inherit}
.csnd{width:28px;height:28px;border-radius:5px;border:none;background:var(--accent);color:#fff;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.cprom{padding:4px 6px;border-radius:4px;border:1px solid var(--border);background:rgba(108,92,231,.02);color:var(--text2);font-size:7px;cursor:pointer;text-align:left;font-family:inherit;transition:all .1s}
.cprom:hover{background:rgba(108,92,231,.06);border-color:var(--border2)}
.kbi{padding:3px 5px;border-radius:3px;font-size:7px;color:var(--text2);display:flex;align-items:center;gap:3px}
.aov{position:absolute;inset:0;background:rgba(4,4,10,.55);backdrop-filter:blur(2px);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:50}.aov.show{display:flex}
.spinner{width:36px;height:36px;border-radius:50%;border:2px solid transparent;border-top-color:var(--accent);border-right-color:var(--accent2);animation:spin .7s linear infinite}
.toasts{position:fixed;top:50px;right:12px;width:290px;z-index:9999}
.toast{background:var(--bg3);border:1px solid var(--border2);border-radius:8px;padding:9px;margin-bottom:6px;animation:slideR .35s ease-out;box-shadow:0 8px 28px rgba(0,0,0,.5);position:relative}
.toast-x{position:absolute;top:4px;right:6px;background:none;border:none;color:var(--text3);cursor:pointer;font-size:10px}
.fib-bar{display:flex;gap:2px;flex-wrap:wrap;margin-top:3px}
.fib-lv{flex:1;min-width:62px;padding:2px 4px;border-radius:3px;text-align:center;font-size:7px}
.fib-lv .fl{color:var(--text3)}.fib-lv .fv{font-size:9px;font-weight:600;font-family:'DM Mono',monospace;margin-top:1px}
</style>
</head>
<body>
<div id="app">
<div id="topbar">
  <div class="logo"><div class="logo-i">S</div><div><div class="logo-t">SMC Terminal</div><div class="logo-s">ICT / SMART MONEY AI</div></div></div>
  <div class="sep"></div>
  <div style="position:relative" id="symw">
    <button class="tb" id="symbtn" onclick="toggleSym()">ğŸ“ˆ <span id="symlbl">XAU/USD</span> <span style="font-size:7px;color:var(--text3)">â–¼</span></button>
    <div class="sdrop" id="sdrop"><input class="ssinp" id="ssinp" placeholder="Search..." oninput="filterSym()"><div class="slist" id="slist"></div></div>
  </div>
  <div class="tfb" id="tfbar"></div>
  <div style="flex:1"></div>
  <div id="price-disp" style="font-family:'DM Mono',monospace;font-size:12px;font-weight:700;margin-right:6px"></div>
  <div class="sess" id="sessbdg"></div>
  <button class="autob" id="autob" onclick="toggleAuto()"><div class="adot"></div><span id="autolbl">AUTO</span></button>
  <button class="abtn" id="abtn" onclick="analyze()">ğŸ” Analyze</button>
  <button class="nbtn" onclick="void(0)">ğŸ””<div class="ncnt" id="ncnt" style="display:none">0</div></button>
</div>
<div id="workspace">
  <div id="chart-col">
    <div id="chart-wrap"></div>
    <div class="aov" id="aov"><div class="spinner"></div><div style="margin-top:8px;font-size:10px;color:#b8a9ff" id="scanst">Fetching live data...</div></div>
    <div id="ai-watcher">
      <div class="aw-head">
        <div class="aw-title"><div class="aw-eye">ğŸ‘</div> AI Watcher <span style="font-size:7px;color:var(--text2);font-weight:400">â€” Live ICT/SMC analysis</span></div>
        <div class="aw-status" id="aw-status"><div class="aw-live"></div><span style="color:var(--green)">WATCHING</span> <span id="aw-sym" style="color:var(--text2)">XAU/USD</span> <span id="data-badge" style="font-size:6px;padding:1px 3px;border-radius:2px;background:rgba(108,92,231,.1);color:var(--text3)">OFFLINE</span></div>
      </div>
      <div class="aw-feed" id="aw-feed"></div>
      <div id="fib-panel" style="display:none"></div>
      <div class="cinw">
        <input id="aw-inp" class="cinp" placeholder="Ask: bias? fib? FVG? should I enter? price?..." onkeydown="if(event.key==='Enter')askWatcher()">
        <button onclick="askWatcher()" class="csnd" style="font-size:9px">Ask</button>
      </div>
    </div>
  </div>
  <div id="right-panel">
    <div class="ptabs" id="ptabs"></div>
    <div class="pbody" id="pbody"></div>
    <div id="cinarea" style="display:none"><div class="cinw"><input class="cinp" id="cinp" placeholder="Ask about ICT/SMC..." onkeydown="if(event.key==='Enter')sendChat()"><button class="csnd" onclick="sendChat()">â†‘</button></div></div>
  </div>
</div>
<div id="statusbar"><div id="stl"></div><div id="str"></div></div>
</div>
<div class="toasts" id="toasts"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SYMS=[
  {s:"OANDA:XAUUSD",n:"Gold",sh:"XAU/USD",yf:"GC=F"},
  {s:"OANDA:EURUSD",n:"EUR/USD",sh:"EUR/USD",yf:"EURUSD=X"},
  {s:"OANDA:GBPUSD",n:"GBP/USD",sh:"GBP/USD",yf:"GBPUSD=X"},
  {s:"FX:USDJPY",n:"USD/JPY",sh:"USD/JPY",yf:"JPY=X"},
  {s:"OANDA:GBPJPY",n:"GBP/JPY",sh:"GBP/JPY",yf:"GBPJPY=X"},
  {s:"BITSTAMP:BTCUSD",n:"Bitcoin",sh:"BTC/USD",yf:"BTC-USD"},
  {s:"BITSTAMP:ETHUSD",n:"Ethereum",sh:"ETH/USD",yf:"ETH-USD"},
  {s:"NASDAQ:AAPL",n:"Apple",sh:"AAPL",yf:"AAPL"},
  {s:"NASDAQ:TSLA",n:"Tesla",sh:"TSLA",yf:"TSLA"},
  {s:"SP:SPX",n:"S&P 500",sh:"SPX",yf:"^GSPC"},
  {s:"OANDA:NAS100USD",n:"NASDAQ 100",sh:"NAS100",yf:"^NDX"},
  {s:"TVC:DXY",n:"Dollar Index",sh:"DXY",yf:"DX-Y.NYB"},
  {s:"OANDA:USOIL",n:"Crude Oil",sh:"WTI",yf:"CL=F"},
  {s:"OANDA:XAGUSD",n:"Silver",sh:"XAG/USD",yf:"SI=F"}
];
const TFS=[{v:"1",l:"1m"},{v:"5",l:"5m"},{v:"15",l:"15m"},{v:"30",l:"30m"},{v:"60",l:"1H"},{v:"240",l:"4H"},{v:"D",l:"1D"},{v:"W",l:"1W"}];
const PREF={'OANDA:XAUUSD':3320,'OANDA:EURUSD':1.085,'OANDA:GBPUSD':1.265,'FX:USDJPY':149.5,'OANDA:GBPJPY':189,'BITSTAMP:BTCUSD':107000,'BITSTAMP:ETHUSD':2600,'NASDAQ:AAPL':225,'NASDAQ:TSLA':340,'SP:SPX':5700,'OANDA:NAS100USD':20500,'TVC:DXY':104,'OANDA:USOIL':62,'OANDA:XAGUSD':33};

const CONCEPTS={"Fair Value Gap (FVG)":"3-candle imbalance where candle 1 high < candle 3 low (bullish) or candle 1 low > candle 3 high (bearish). Price returns to fill.","Order Block (OB)":"Last opposing candle before displacement. Bullish OB = last bearish before up move.","Break of Structure (BOS)":"Price breaks swing H/L confirming trend.","Change of Character (CHoCH)":"First break of opposite structure â€” reversal signal.","Liquidity (BSL/SSL)":"BSL above swing highs, SSL below lows. Institutions target these.","Displacement":"3+ strong same-direction candles. Institutional commitment.","OTE Zone":"50-61.8% Fibonacci retracement. Optimal entry area.","Kill Zone":"London 3-5AM EST. NY 10AM-12PM EST. Peak institutional windows.","Premium/Discount":"Above 50% of range = premium. Below = discount.","Equal Highs/Lows":"Same-level touches = liquidity pool target."};
const TECHNIQUES={"2022 ICT Model":"HTF bias â†’ KZ sweep â†’ Displacement+FVG â†’ OTE â†’ TP liquidity","Silver Bullet":"10-11AM or 1-2PM â†’ FVG forms â†’ Enter on return","Turtle Soup":"False breakout â†’ reversal with MSS confirmation","Liquidity Sweep":"Key level swept â†’ Displacement opposite â†’ Enter pullback","OTE Fibonacci":"Enter at 0.618 retracement with FVG/OB confluence"};

let S={sym:SYMS[0],tf:"15",analysis:null,busy:false,auto:false,autoI:null,notifs:[],tab:"analysis",msgs:[],typing:false,watcherI:null,watcherCycle:0,candles:[],livePrice:0,dataLive:false,dataI:null,fib:null,ict:null};

// Format price based on magnitude
function F(v){if(v==null||isNaN(v))return'â€”';const b=S.livePrice||PREF[S.sym.s]||100;return b<10?v.toFixed(4):b<200?v.toFixed(2):b<2000?v.toFixed(1):v.toFixed(0)}
function Fc(v){const s=F(v);return Number(s).toLocaleString('en-US',{minimumFractionDigits:s.includes('.')?s.split('.')[1].length:0})}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SESSION DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getSess(){const h=(new Date().getUTCHours()-5+24)%24;if(h>=20||h<3)return{n:"Asian",p:"Accumulation",i:"ğŸŒ",c:"var(--yellow)",kz:false};if(h>=3&&h<5)return{n:"London KZ",p:"Manipulation",i:"ğŸ‡¬ğŸ‡§",c:"var(--red)",kz:true};if(h>=5&&h<10)return{n:"London",p:"Continuation",i:"ğŸ‡¬ğŸ‡§",c:"var(--blue)",kz:false};if(h>=10&&h<12)return{n:"NY KZ",p:"High Probability",i:"ğŸ‡ºğŸ‡¸",c:"var(--green)",kz:true};if(h>=12&&h<13)return{n:"NY Lunch",p:"Low Volume",i:"ğŸ½",c:"var(--text3)",kz:false};if(h>=13&&h<14)return{n:"Silver Bullet",p:"PM Window",i:"ğŸ”«",c:"var(--accent)",kz:true};if(h>=14&&h<17)return{n:"NY PM",p:"Continuation",i:"ğŸ‡ºğŸ‡¸",c:"var(--blue)",kz:false};return{n:"Off Hours",p:"Wait",i:"â¸",c:"var(--text3)",kz:false}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 1. LIVE DATA ENGINE â€” Yahoo Finance via CORS proxy
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchLiveData(){
  const yf=S.sym.yf;
  const tfMap={'1':'1m','5':'5m','15':'15m','30':'30m','60':'60m','240':'60m','D':'1d','W':'1wk'};
  const rangeMap={'1':'1d','5':'2d','15':'5d','30':'5d','60':'10d','240':'30d','D':'6mo','W':'1y'};
  const interval=tfMap[S.tf]||'15m';
  const range=rangeMap[S.tf]||'5d';
  const url=`https://corsproxy.io/?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${yf}?interval=${interval}&range=${range}`)}`;
  try{
    const res=await fetch(url,{signal:AbortSignal.timeout(8000)});
    if(!res.ok)throw new Error(res.status);
    const json=await res.json();
    const r=json.chart?.result?.[0];
    if(!r||!r.timestamp)throw new Error('No data');
    const ts=r.timestamp,q=r.indicators.quote[0];
    const candles=[];
    for(let i=0;i<ts.length;i++){
      if(q.open[i]==null||q.high[i]==null||q.low[i]==null||q.close[i]==null)continue;
      candles.push({t:ts[i]*1000,o:q.open[i],h:q.high[i],l:q.low[i],c:q.close[i],v:q.volume?.[i]||0});
    }
    S.candles=candles.slice(-100);
    S.livePrice=S.candles.length?S.candles[S.candles.length-1].c:PREF[S.sym.s]||0;
    S.dataLive=true;
    document.getElementById('data-badge').textContent='LIVE';
    document.getElementById('data-badge').style.background='rgba(0,212,170,.12)';
    document.getElementById('data-badge').style.color='var(--green)';
    return true;
  }catch(e){
    console.warn('Fetch failed:',e.message);
    S.dataLive=false;
    S.livePrice=PREF[S.sym.s]||100;
    document.getElementById('data-badge').textContent='OFFLINE';
    document.getElementById('data-badge').style.background='rgba(255,71,87,.1)';
    document.getElementById('data-badge').style.color='var(--red)';
    return false;
  }
}

function startDataFeed(){
  if(S.dataI)clearInterval(S.dataI);
  fetchLiveData().then(ok=>{
    if(ok){
      awMsg('sys',`ğŸ“¡ <strong>Live data:</strong> <span class="a">${S.sym.sh}</span> â€” ${S.candles.length} candles loaded. Price: <span class="g">${Fc(S.livePrice)}</span>`);
      runICT();
    }else{
      awMsg('sys',`âš ï¸ <strong>Offline mode</strong> for ${S.sym.sh}. Using reference price ${Fc(S.livePrice)}.`);
    }
  });
  S.dataI=setInterval(async()=>{
    const ok=await fetchLiveData();
    if(ok&&S.candles.length>=20)runICT();
    updPrice();
  },30000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 2. REAL ICT/SMC PATTERN DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function findSwings(c,lb=4){
  const highs=[],lows=[];
  for(let i=lb;i<c.length-lb;i++){
    let isH=true,isL=true;
    for(let j=1;j<=lb;j++){
      if(c[i].h<=c[i-j].h||c[i].h<=c[i+j].h)isH=false;
      if(c[i].l>=c[i-j].l||c[i].l>=c[i+j].l)isL=false;
    }
    if(isH)highs.push({p:c[i].h,i:i,t:c[i].t});
    if(isL)lows.push({p:c[i].l,i:i,t:c[i].t});
  }
  return{highs,lows};
}

function analyzeCandles(c){
  if(c.length<20)return null;
  const price=c[c.length-1].c;
  const sw=findSwings(c,3);
  const A={price,fvgs:[],obs:[],bos:null,choch:null,sweeps:[],eqHL:[],bias:'Neutral',structure:'',disp:null,pd:null,ote:null,sess:getSess(),dets:[],conf:35,trade:null};

  // â”€â”€ MARKET BIAS: HH/HL vs LH/LL â”€â”€
  if(sw.highs.length>=2&&sw.lows.length>=2){
    const lh=sw.highs.slice(-4),ll=sw.lows.slice(-4);
    let hh=0,lhc=0,hl=0,llc=0;
    for(let i=1;i<lh.length;i++){if(lh[i].p>lh[i-1].p)hh++;else lhc++}
    for(let i=1;i<ll.length;i++){if(ll[i].p>ll[i-1].p)hl++;else llc++}
    if(hh>lhc&&hl>llc){A.bias='Bullish';A.structure=`HH(${hh})+HL(${hl}) â€” bullish`}
    else if(lhc>hh&&llc>hl){A.bias='Bearish';A.structure=`LH(${lhc})+LL(${llc}) â€” bearish`}
    else A.structure='Mixed â€” ranging';
  }

  // â”€â”€ FAIR VALUE GAPS â”€â”€
  for(let i=1;i<c.length-1;i++){
    if(c[i-1].h<c[i+1].l) A.fvgs.push({type:'bull',top:c[i+1].l,bot:c[i-1].h,mid:(c[i+1].l+c[i-1].h)/2,idx:i});
    if(c[i-1].l>c[i+1].h) A.fvgs.push({type:'bear',top:c[i-1].l,bot:c[i+1].h,mid:(c[i-1].l+c[i+1].h)/2,idx:i});
  }

  // â”€â”€ ORDER BLOCKS â”€â”€
  const avgBody=c.slice(-20).reduce((s,x)=>s+Math.abs(x.c-x.o),0)/20;
  for(let i=1;i<c.length-3;i++){
    let bullRun=0,bearRun=0;
    for(let j=i;j<Math.min(i+4,c.length);j++){
      if(c[j].c>c[j].o&&Math.abs(c[j].c-c[j].o)>avgBody*1.3)bullRun++;
      if(c[j].c<c[j].o&&Math.abs(c[j].c-c[j].o)>avgBody*1.3)bearRun++;
    }
    if(bullRun>=3&&c[i-1].c<c[i-1].o) A.obs.push({type:'bull',hi:c[i-1].h,lo:c[i-1].l,mid:(c[i-1].h+c[i-1].l)/2,idx:i-1,strength:bullRun});
    if(bearRun>=3&&c[i-1].c>c[i-1].o) A.obs.push({type:'bear',hi:c[i-1].h,lo:c[i-1].l,mid:(c[i-1].h+c[i-1].l)/2,idx:i-1,strength:bearRun});
  }

  // â”€â”€ BOS â”€â”€
  const last20H=Math.max(...c.slice(-20).map(x=>x.h));
  const last20L=Math.min(...c.slice(-20).map(x=>x.l));
  if(price>last20H) A.bos={type:'bull',level:last20H};
  else if(price<last20L) A.bos={type:'bear',level:last20L};

  // â”€â”€ LIQUIDITY SWEEPS (last 8 candles) â”€â”€
  for(let i=Math.max(0,c.length-8);i<c.length;i++){
    const lookback=c.slice(Math.max(0,i-20),i);
    if(lookback.length<5)continue;
    const prevH=Math.max(...lookback.map(x=>x.h));
    const prevL=Math.min(...lookback.map(x=>x.l));
    if(c[i].h>prevH*(1+0.001)&&c[i].c<prevH) A.sweeps.push({type:'bsl',level:prevH,wick:c[i].h,idx:i});
    if(c[i].l<prevL*(1-0.001)&&c[i].c>prevL) A.sweeps.push({type:'ssl',level:prevL,wick:c[i].l,idx:i});
  }

  // â”€â”€ EQUAL HIGHS/LOWS â”€â”€
  const tol=price*0.001;
  for(let i=0;i<sw.highs.length;i++)for(let j=i+1;j<sw.highs.length;j++)
    if(Math.abs(sw.highs[i].p-sw.highs[j].p)<tol) A.eqHL.push({type:'eqh',level:(sw.highs[i].p+sw.highs[j].p)/2,count:2});
  for(let i=0;i<sw.lows.length;i++)for(let j=i+1;j<sw.lows.length;j++)
    if(Math.abs(sw.lows[i].p-sw.lows[j].p)<tol) A.eqHL.push({type:'eql',level:(sw.lows[i].p+sw.lows[j].p)/2,count:2});

  // â”€â”€ DISPLACEMENT â”€â”€
  const avg10=c.slice(-14,-4).reduce((s,x)=>s+Math.abs(x.c-x.o),0)/10||1;
  let dCnt=0,dDir=0;
  for(let i=c.length-4;i<c.length;i++){
    if(Math.abs(c[i].c-c[i].o)>avg10*2){dCnt++;dDir+=c[i].c>c[i].o?1:-1}
  }
  if(dCnt>=2) A.disp={dir:dDir>0?'bull':'bear',strength:dCnt};

  // â”€â”€ PREMIUM/DISCOUNT â”€â”€
  if(sw.highs.length&&sw.lows.length){
    const rH=Math.max(...sw.highs.slice(-4).map(h=>h.p));
    const rL=Math.min(...sw.lows.slice(-4).map(l=>l.p));
    if(rH>rL){const eq=(rH+rL)/2;A.pd={hi:rH,lo:rL,eq,zone:price>eq?'premium':'discount',pct:((price-rL)/(rH-rL)*100).toFixed(0)}}
  }

  // â”€â”€ OTE ZONE â”€â”€
  if(sw.highs.length&&sw.lows.length){
    const sH=sw.highs[sw.highs.length-1].p,sL=sw.lows[sw.lows.length-1].p;
    const range=Math.abs(sH-sL);
    if(range>0){
      if(sw.highs[sw.highs.length-1].i>sw.lows[sw.lows.length-1].i){
        // Swing up, looking for retrace down
        A.ote={top:sL+range*0.618,bot:sL+range*0.5,golden:sL+range*0.618,sH,sL};
      }else{
        A.ote={top:sH-range*0.5,bot:sH-range*0.618,golden:sH-range*0.618,sH,sL};
      }
    }
  }

  // â”€â”€ BUILD DETECTIONS LIST â”€â”€
  const d=A.dets;
  A.fvgs.slice(-3).forEach(f=>d.push({t:"FVG",d:`${f.type==='bull'?'Bullish':'Bearish'} FVG: ${Fc(f.bot)} â€” ${Fc(f.top)}, CE: ${Fc(f.mid)}`,p:"high",i:"ğŸ“Š"}));
  A.obs.slice(-2).forEach(o=>d.push({t:"Order Block",d:`${o.type==='bull'?'Bullish':'Bearish'} OB: ${Fc(o.lo)} â€” ${Fc(o.hi)} (${o.strength}-candle displacement)`,p:"high",i:"ğŸ§±"}));
  if(A.bos)d.push({t:"BOS",d:`${A.bos.type==='bull'?'Bullish':'Bearish'} â€” broke ${Fc(A.bos.level)}`,p:"medium",i:"ğŸ“ˆ"});
  A.sweeps.forEach(s=>d.push({t:"Liquidity Sweep",d:`${s.type==='bsl'?'BSL':'SSL'} swept at ${Fc(s.level)}, wick to ${Fc(s.wick)}`,p:"critical",i:"ğŸ’§"}));
  A.eqHL.slice(-2).forEach(e=>d.push({t:e.type==='eqh'?"Equal Highs":"Equal Lows",d:`${e.type==='eqh'?'BSL':'SSL'} pool at ${Fc(e.level)}`,p:"medium",i:"âš–ï¸"}));
  if(A.disp)d.push({t:"Displacement",d:`${A.disp.dir==='bull'?'Bullish':'Bearish'} â€” ${A.disp.strength} strong candles`,p:"high",i:"âš¡"});
  if(A.pd)d.push({t:"Premium/Discount",d:`${A.pd.zone.toUpperCase()} (${A.pd.pct}%). EQ: ${Fc(A.pd.eq)}`,p:"medium",i:"ğŸ’°"});
  if(A.ote){const inOTE=price>=Math.min(A.ote.bot,A.ote.top)&&price<=Math.max(A.ote.bot,A.ote.top);
    d.push({t:"OTE Zone",d:`${Fc(A.ote.bot)} â€” ${Fc(A.ote.top)}${inOTE?' â† PRICE IN OTE':''}`,p:inOTE?"critical":"medium",i:"ğŸ¯"})}
  if(A.sess.kz)d.push({t:"Kill Zone",d:`${A.sess.n} ACTIVE`,p:"critical",i:"ğŸ•"});

  // â”€â”€ CONFIDENCE â”€â”€
  let conf=35;
  if(A.bias!=='Neutral')conf+=10;
  if(A.fvgs.length)conf+=8;
  if(A.obs.length)conf+=8;
  if(A.sweeps.length)conf+=15;
  if(A.disp)conf+=10;
  if(A.sess.kz)conf+=8;
  if(A.ote){const inOTE=price>=Math.min(A.ote.bot,A.ote.top)&&price<=Math.max(A.ote.bot,A.ote.top);if(inOTE)conf+=12}
  A.conf=Math.min(conf,98);

  // â”€â”€ TRADE SETUP (only with real confluence) â”€â”€
  const hasSweep=A.sweeps.length>0;
  const hasDisp=A.disp!==null;
  const hasFVGorOB=A.fvgs.length>0||A.obs.length>0;
  const inOTE=A.ote&&price>=Math.min(A.ote.bot,A.ote.top)&&price<=Math.max(A.ote.bot,A.ote.top);
  const kzActive=A.sess.kz;

  if(A.bias!=='Neutral'&&hasFVGorOB&&(hasSweep||hasDisp)&&(inOTE||kzActive||A.conf>=75)){
    const dir=A.bias==='Bullish'?'LONG':'SHORT';
    const entryRef=A.fvgs.length?A.fvgs[A.fvgs.length-1].mid:A.obs[A.obs.length-1].mid;
    const sweepWick=A.sweeps.length?A.sweeps[A.sweeps.length-1].wick:null;
    const slLev=dir==='LONG'?(sweepWick&&sweepWick<entryRef?sweepWick:entryRef*(1-0.005)):(sweepWick&&sweepWick>entryRef?sweepWick:entryRef*(1+0.005));
    const slDist=Math.abs(entryRef-slLev);
    const tpTarget=A.eqHL.length?A.eqHL[A.eqHL.length-1].level:dir==='LONG'?entryRef+slDist*3.5:entryRef-slDist*3.5;
    const rr=(Math.abs(tpTarget-entryRef)/slDist).toFixed(1);
    const models=["2022 ICT Model","Silver Bullet","Liquidity Sweep","OTE Fibonacci","Turtle Soup"];
    let model=models[0];
    if(hasSweep&&hasDisp)model="Liquidity Sweep";if(kzActive&&A.fvgs.length)model="Silver Bullet";if(inOTE)model="OTE Fibonacci";
    A.trade={dir,entry:F(entryRef),sl:F(slLev),tp1:F(dir==='LONG'?entryRef+slDist*2:entryRef-slDist*2),tp2:F(tpTarget),rr:'1:'+rr,risk:"1-2%",model};
  }
  return A;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 3. FIBONACCI CALCULATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcFib(c){
  if(c.length<10)return null;
  const recent=c.slice(-30);
  const sH=Math.max(...recent.map(x=>x.h));
  const sL=Math.min(...recent.map(x=>x.l));
  const range=sH-sL;if(range<=0)return null;
  const price=c[c.length-1].c;
  const ratios=[0,0.236,0.382,0.5,0.618,0.705,0.786,1];
  const levels=ratios.map(r=>({r,price:sH-range*r,label:r===0?'0 (High)':r===1?'1.0 (Low)':String(r)}));
  return{sH,sL,range,levels,price,pct:((sH-price)/range*100).toFixed(1),inOTE:price<=(sH-range*0.5)&&price>=(sH-range*0.618)};
}

function showFib(){
  const fp=document.getElementById('fib-panel');
  S.fib=S.candles.length>=10?calcFib(S.candles):null;
  if(!S.fib){fp.style.display='none';return}
  fp.style.display='block';
  const f=S.fib;
  fp.innerHTML=`<div style="padding:5px 8px;background:var(--bg3);border-top:1px solid var(--border)">
    <div style="font-size:7px;font-weight:700;color:#b8a9ff;margin-bottom:3px">ğŸ“ FIB: ${Fc(f.sH)} â†’ ${Fc(f.sL)} | Price at ${f.pct}% ${f.inOTE?'<span style="color:var(--green)">IN OTE</span>':''}</div>
    <div class="fib-bar">${f.levels.map(lv=>{
      const isOTE=lv.r>=0.5&&lv.r<=0.618;
      const near=Math.abs(f.price-lv.price)/f.range<0.025;
      return`<div class="fib-lv" style="background:${near?'rgba(108,92,231,.15)':isOTE?'rgba(0,212,170,.06)':'rgba(0,0,0,.15)'};border:1px solid ${near?'var(--accent)':isOTE?'rgba(0,212,170,.15)':'transparent'}"><div class="fl">${lv.label}${isOTE?' â˜…':''}</div><div class="fv" style="color:${near?'var(--accent)':'var(--text1)'}">${Fc(lv.price)}</div></div>`}).join('')}</div></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 4. AI WATCHER â€” Live ICT Narration
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runICT(){
  if(S.candles.length<20)return;
  S.ict=analyzeCandles(S.candles);
  S.fib=calcFib(S.candles);
  showFib();
  updPrice();
}

function startWatcher(){
  if(S.watcherI)clearInterval(S.watcherI);
  document.getElementById('aw-feed').innerHTML='';
  awMsg('sys',`ğŸ‘ <strong>AI Watcher</strong> on <span class="a">${S.sym.sh}</span> (${TFS.find(t=>t.v===S.tf)?.l}). Fetching live data...`);
  startDataFeed();
  S.watcherCycle=0;
  S.watcherI=setInterval(()=>{
    S.watcherCycle++;
    if(!S.ict||!S.candles.length)return;
    narrateICT();
  },12000);
}

function narrateICT(){
  const A=S.ict;if(!A)return;
  const p=S.livePrice;
  const pool=[];

  // Real observations from actual detections
  pool.push(`ğŸ“ <strong>Structure:</strong> <span class="${A.bias==='Bullish'?'g':A.bias==='Bearish'?'r':'y'}">${A.bias}</span> â€” ${A.structure}. Price: <span class="a">${Fc(p)}</span>`);

  if(A.fvgs.length){const f=A.fvgs[A.fvgs.length-1];const near=Math.abs(p-f.mid)/p<0.003;
    pool.push(`ğŸ“Š <strong>FVG:</strong> ${f.type==='bull'?'Bullish':'Bearish'} gap <span class="a">${Fc(f.bot)} â€” ${Fc(f.top)}</span>. CE: ${Fc(f.mid)}. ${near?'<span class="g">Price near fill zone!</span>':'Watching.'}`)}

  if(A.obs.length){const o=A.obs[A.obs.length-1];
    pool.push(`ğŸ§± <strong>OB:</strong> ${o.type==='bull'?'Bullish':'Bearish'} at <span class="a">${Fc(o.lo)} â€” ${Fc(o.hi)}</span>. ${o.strength}-candle displacement. ${Math.abs(p-o.mid)/p<0.005?'<span class="g">Price at OB!</span>':'Marked.'}`)}

  if(A.sweeps.length){const s=A.sweeps[A.sweeps.length-1];
    pool.push(`ğŸ’§ <strong>Sweep:</strong> ${s.type==='bsl'?'<span class="r">BSL</span>':'<span class="g">SSL</span>'} swept at ${Fc(s.level)}, wick ${Fc(s.wick)}. Stops taken.`)}

  if(A.disp)pool.push(`âš¡ <strong>Displacement:</strong> ${A.disp.dir==='bull'?'<span class="g">Bullish</span>':'<span class="r">Bearish</span>'} â€” ${A.disp.strength} strong candles.`);

  if(A.pd)pool.push(`ğŸ’° Price ${Fc(p)} in <span class="${A.pd.zone==='discount'?'g':'r'}">${A.pd.zone.toUpperCase()}</span> (${A.pd.pct}%). EQ: ${Fc(A.pd.eq)}.`);

  if(A.eqHL.length){const e=A.eqHL[A.eqHL.length-1];pool.push(`âš–ï¸ <strong>${e.type==='eqh'?'Equal Highs (BSL)':'Equal Lows (SSL)'}:</strong> Pool at <span class="y">${Fc(e.level)}</span>. Institutional target.`)}

  if(A.bos)pool.push(`ğŸ“ˆ <strong>BOS:</strong> ${A.bos.type==='bull'?'<span class="g">Bullish</span>':'<span class="r">Bearish</span>'} â€” broke ${Fc(A.bos.level)}.`);

  pool.push(`ğŸ• <strong>${A.sess.n}:</strong> ${A.sess.p}. ${A.sess.kz?'<span class="g">Kill Zone ACTIVE</span>':'Standard session.'}`);

  // Pick 1-2 random from pool
  const picks=pool.sort(()=>Math.random()-.5).slice(0,2);
  picks.forEach((m,i)=>setTimeout(()=>awMsg('obs',m),i*1500));

  // Alert if trade signal available
  if(A.trade&&A.conf>=70&&S.watcherCycle%3===0){
    setTimeout(()=>awAlert(A.trade.dir==='LONG'?'buy':'sell',
      `<strong>ğŸ”” ${A.trade.dir} ${S.sym.sh}</strong> (${A.trade.model}, ${A.conf}%) â€” Entry: ${A.trade.entry} | SL: <span class="r">${A.trade.sl}</span> | TP1: <span class="g">${A.trade.tp1}</span> | TP2: <span class="b">${A.trade.tp2}</span> | R:R ${A.trade.rr}`),3500);
  }
}

function awMsg(type,html){const t=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});const ic={sys:'ğŸ¤–',info:'â„¹ï¸',obs:'ğŸ‘'}[type]||'ğŸ‘';const f=document.getElementById('aw-feed');const d=document.createElement('div');d.className='aw-msg';d.innerHTML=`<div class="aw-ts">${t}</div><div class="aw-ico">${ic}</div><div class="aw-txt">${html}</div>`;f.appendChild(d);f.scrollTop=f.scrollHeight;while(f.children.length>60)f.removeChild(f.firstChild)}
function awAlert(type,html){const t=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});const f=document.getElementById('aw-feed');const d=document.createElement('div');d.className=`aw-alert ${type}`;d.innerHTML=`<div class="aw-ts">${t}</div><div class="aw-txt">${html}</div>`;f.appendChild(d);f.scrollTop=f.scrollHeight;while(f.children.length>60)f.removeChild(f.firstChild)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 5. CHART QUESTION BOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function askWatcher(){
  const inp=document.getElementById('aw-inp');const msg=inp.value.trim();if(!msg)return;inp.value='';
  awMsg('info',`<span class="b">You:</span> ${msg}`);
  setTimeout(()=>awMsg('obs',answerQ(msg)),300);
}

function answerQ(msg){
  const m=msg.toLowerCase();const A=S.ict;const fi=S.fib;const p=S.livePrice;
  if(!A||!S.candles.length)return'âš ï¸ No data yet â€” waiting for candles...';

  if(m.includes('fib')||m.includes('retracement')||m.includes('draw fib')){
    showFib();document.getElementById('fib-panel').style.display='block';
    if(!fi)return'ğŸ“ Not enough data for Fibonacci.';
    return`ğŸ“ <strong>Fibonacci</strong> (${Fc(fi.sH)} â†’ ${Fc(fi.sL)}): Price at <span class="a">${fi.pct}% retrace</span>. ${fi.inOTE?'<span class="g">IN OTE ZONE</span>':'Outside OTE.'} Levels: 0.382=${Fc(fi.levels[2].price)}, <strong>0.5=${Fc(fi.levels[3].price)}</strong>, <strong>0.618=${Fc(fi.levels[4].price)}</strong>, 0.786=${Fc(fi.levels[6].price)}`}

  if(m.includes('bias')||m.includes('trend')||m.includes('direction'))
    return`ğŸ“ <strong>Bias: <span class="${A.bias==='Bullish'?'g':A.bias==='Bearish'?'r':'y'}">${A.bias}</span></strong> â€” ${A.structure}. Conf: ${A.conf}%. ${A.pd?`Price in ${A.pd.zone} (${A.pd.pct}%).`:''} ${A.disp?`${A.disp.dir} displacement active.`:'No displacement.'}`;

  if(m.includes('fvg')||m.includes('fair value')||m.includes('gap')||m.includes('imbalance')){
    if(!A.fvgs.length)return'ğŸ“Š No Fair Value Gaps in recent candles.';
    return`ğŸ“Š <strong>${A.fvgs.length} FVGs:</strong> ${A.fvgs.slice(-4).map(f=>`${f.type==='bull'?'ğŸŸ¢':'ğŸ”´'} ${Fc(f.bot)}-${Fc(f.top)} CE:${Fc(f.mid)}`).join(' | ')}. ${Math.abs(p-A.fvgs[A.fvgs.length-1].mid)/p<0.003?'<span class="g">Near FVG!</span>':'Monitoring.'}`}

  if(m.includes('order block')||m.includes(' ob')||m.match(/\bob\b/))
    return A.obs.length?`ğŸ§± <strong>${A.obs.length} OBs:</strong> ${A.obs.slice(-3).map(o=>`${o.type==='bull'?'ğŸŸ¢':'ğŸ”´'} ${Fc(o.lo)}-${Fc(o.hi)} (${o.strength}x disp)`).join(' | ')}`:'ğŸ§± No Order Blocks detected.';

  if(m.includes('sweep')||m.includes('liquidity')||m.includes('stop hunt'))
    return A.sweeps.length?`ğŸ’§ <strong>Sweeps:</strong> ${A.sweeps.map(s=>`${s.type==='bsl'?'BSL':'SSL'} at ${Fc(s.level)}, wick ${Fc(s.wick)}`).join(' | ')}`:'ğŸ’§ No sweeps in recent candles.';

  if(m.includes('enter')||m.includes('trade')||m.includes('setup')||m.includes('should i')){
    if(!A.trade)return`â³ <strong>NO TRADE.</strong> Missing confluence:<br>${A.sweeps.length?'âœ…':'âŒ'} Sweep | ${A.disp?'âœ…':'âŒ'} Displacement | ${A.fvgs.length||A.obs.length?'âœ…':'âŒ'} FVG/OB | ${fi?.inOTE?'âœ…':'âŒ'} OTE | ${A.sess.kz?'âœ…':'âš ï¸'} Kill Zone<br><span class="y">Patience â€” wait for all confluences.</span>`;
    const checks=[A.sweeps.length?'âœ… Sweep':'âŒ Sweep',A.disp?'âœ… Displacement':'âŒ Displacement',A.fvgs.length||A.obs.length?'âœ… FVG/OB':'âŒ FVG/OB',fi?.inOTE?'âœ… OTE':'âŒ OTE',A.sess.kz?'âœ… Kill Zone':'âš ï¸ No KZ'];
    return`<strong>${A.trade.dir==='LONG'?'ğŸŸ¢':'ğŸ”´'} ${A.trade.dir} ${S.sym.sh}</strong> â€” ${A.trade.model}<br>${checks.join(' | ')}<br>Entry: <span class="a">${A.trade.entry}</span> | SL: <span class="r">${A.trade.sl}</span> | TP1: <span class="g">${A.trade.tp1}</span> | TP2: <span class="b">${A.trade.tp2}</span> | R:R ${A.trade.rr} | Conf: <span class="${A.conf>=75?'g':'y'}">${A.conf}%</span>`}

  if(m.includes('price'))return`ğŸ’µ <strong>${S.sym.sh}:</strong> ${Fc(p)} ${S.dataLive?'ğŸ“¡ LIVE':'âš ï¸ OFFLINE'} ${A.pd?`| ${A.pd.zone} (${A.pd.pct}%)`:''} ${fi?`| Fib: ${fi.pct}%`:''}`;

  if(m.includes('session')||m.includes('kill zone')||m.includes('kz'))return`ğŸ• <strong>${A.sess.n}</strong> â€” ${A.sess.p}. ${A.sess.kz?'<span class="g">KZ ACTIVE â€” prime for setups.</span>':'No Kill Zone. Wait for London 3-5AM or NY 10AM-12PM EST.'}`;

  return`ğŸ¤– Ask: <span class="a">bias, fib, FVG, OB, sweep, trade, should I enter, price, session</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHART + TOPBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadChart(){const sym=S.sym.s,tf=S.tf;document.getElementById('chart-wrap').innerHTML=`<iframe src="https://www.tradingview.com/widgetembed/?frameElementId=tv&symbol=${encodeURIComponent(sym)}&interval=${tf}&hidesidetoolbar=0&hidetoptoolbar=0&symboledit=1&saveimage=1&toolbarbg=1e222d&studies=MAExp%40tv-basicstudies%1FVWAP%40tv-basicstudies&theme=dark&style=1&timezone=exchange&locale=en&utm_source=localhost&utm_medium=widget_new&utm_campaign=chart&utm_term=${encodeURIComponent(sym)}" style="width:100%;height:100%;border:none" allowfullscreen></iframe>`}

function updPrice(){const el=document.getElementById('price-disp');if(S.livePrice)el.innerHTML=`<span style="color:${S.ict?.bias==='Bullish'?'var(--green)':S.ict?.bias==='Bearish'?'var(--red)':'var(--text1)'}">${Fc(S.livePrice)}</span>`}

function rTF(){document.getElementById('tfbar').innerHTML=TFS.map(t=>`<button class="tf ${S.tf===t.v?'on':''}" onclick="chTF('${t.v}')">${t.l}</button>`).join('')}
function rSess(){const s=getSess();document.getElementById('sessbdg').innerHTML=`${s.i} <span style="color:${s.c}">${s.n}</span>${s.kz?'<span class="kzt">KZ</span>':''}`}
function rSymList(){const q=document.getElementById('ssinp').value.toLowerCase();document.getElementById('slist').innerHTML=SYMS.filter(s=>s.n.toLowerCase().includes(q)||s.sh.toLowerCase().includes(q)).map(s=>`<div class="si hover-row ${s.s===S.sym.s?'act':''}" onclick="selSym('${s.s}')"><span>${s.n}</span><span style="font-size:8px;color:var(--accent);font-family:'DM Mono',monospace">${s.sh}</span></div>`).join('')}
function toggleSym(){const d=document.getElementById('sdrop');d.classList.toggle('open');if(d.classList.contains('open')){rSymList();document.getElementById('ssinp').focus()}}
function filterSym(){rSymList()}
function selSym(sym){S.sym=SYMS.find(s=>s.s===sym);S.analysis=null;S.candles=[];S.ict=null;S.fib=null;document.getElementById('symlbl').textContent=S.sym.sh;document.getElementById('sdrop').classList.remove('open');document.getElementById('aw-sym').textContent=S.sym.sh;loadChart();rPanel();startWatcher()}
function chTF(tf){S.tf=tf;S.analysis=null;S.candles=[];S.ict=null;rTF();loadChart();rPanel();startDataFeed();awMsg('sys',`ğŸ”„ TF â†’ <span class="a">${TFS.find(t=>t.v===tf)?.l}</span>`)}
function toggleAuto(){S.auto=!S.auto;const b=document.getElementById('autob'),l=document.getElementById('autolbl');if(S.auto){b.classList.add('on');l.textContent='AUTO ON';analyze();S.autoI=setInterval(analyze,45000)}else{b.classList.remove('on');l.textContent='AUTO';if(S.autoI)clearInterval(S.autoI)}}

function analyze(){
  if(S.busy)return;S.busy=true;document.getElementById('abtn').disabled=true;document.getElementById('aov').classList.add('show');
  document.getElementById('scanst').textContent='Fetching live candles...';
  fetchLiveData().then(ok=>{
    if(ok&&S.candles.length>=20){
      document.getElementById('scanst').textContent='Running ICT/SMC analysis...';
      S.ict=analyzeCandles(S.candles);S.fib=calcFib(S.candles);S.analysis=S.ict;showFib();
      // Generate notification if trade found
      if(S.analysis?.trade&&S.analysis.conf>=70){
        const a=S.analysis,n={id:Date.now(),time:new Date(),sym:S.sym.sh,dir:a.trade.dir,conf:a.conf,model:a.trade.model,entry:a.trade.entry,sl:a.trade.sl,tp1:a.trade.tp1,tp2:a.trade.tp2,rr:a.trade.rr,dets:a.dets.filter(d=>d.p==='critical').map(d=>d.t),read:false};
        S.notifs.unshift(n);if(S.notifs.length>30)S.notifs=S.notifs.slice(0,30);updNC();showToast(n);
      }
      awMsg('obs',`ğŸ“Š <strong>Analysis:</strong> <span class="${S.analysis.bias==='Bullish'?'g':S.analysis.bias==='Bearish'?'r':'y'}">${S.analysis.bias}</span> ${S.analysis.conf}% â€” ${S.analysis.dets.length} detections. ${S.analysis.trade?`Signal: ${S.analysis.trade.dir} @ ${S.analysis.trade.entry}`:'No trade.'}`);
    }else{
      document.getElementById('scanst').textContent='Insufficient data';
      S.analysis=null;
    }
    S.busy=false;document.getElementById('abtn').disabled=false;document.getElementById('aov').classList.remove('show');
    S.tab='analysis';rPanel();
  });
}

function showToast(n){const c=document.getElementById('toasts'),id='t'+n.id,d=document.createElement('div');d.className='toast';d.id=id;d.style.position='relative';d.innerHTML=`<button class="toast-x" onclick="document.getElementById('${id}').remove()">âœ•</button><div style="display:flex;align-items:center;gap:4px;margin-bottom:4px"><span style="font-size:11px">${n.dir==='LONG'?'ğŸŸ¢':'ğŸ”´'}</span><span style="font-size:11px;font-weight:800;color:${n.dir==='LONG'?'var(--green)':'var(--red)'};font-family:'DM Mono',monospace">${n.dir} ${n.sym}</span><span style="font-size:9px;font-weight:700;color:${n.conf>=80?'var(--green)':'var(--yellow)'};font-family:'DM Mono',monospace;margin-left:auto">${n.conf}%</span></div><div style="font-size:7px;color:var(--accent);font-weight:600;margin-bottom:3px">âš¡ ${n.model}</div><div class="g4">${[{l:'ENTRY',v:n.entry,c:'var(--text1)'},{l:'SL',v:n.sl,c:'var(--red)'},{l:'TP1',v:n.tp1,c:'var(--green)'},{l:'TP2',v:n.tp2,c:'var(--blue)'}].map(x=>`<div style="text-align:center;padding:2px;background:rgba(0,0,0,.2);border-radius:2px"><div style="font-size:5px;color:var(--text3)">${x.l}</div><div style="font-size:8px;font-weight:600;color:${x.c};font-family:'DM Mono',monospace">${x.v}</div></div>`).join('')}</div>`;c.appendChild(d);setTimeout(()=>{const el=document.getElementById(id);if(el)el.remove()},8000)}
function updNC(){const u=S.notifs.filter(n=>!n.read).length;const el=document.getElementById('ncnt');if(u>0){el.style.display='flex';el.textContent=u}else el.style.display='none'}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PANEL RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rPanel(){
  const u=S.notifs.filter(n=>!n.read).length;
  document.getElementById('ptabs').innerHTML=[{id:'analysis',l:'ğŸ“Š ANALYSIS',b:S.analysis?1:0},{id:'signals',l:'ğŸ”” SIGNALS',b:u},{id:'chat',l:'ğŸ’¬ CHAT',b:0},{id:'kb',l:'ğŸ“˜ KB',b:0}].map(t=>`<button class="ptab ${S.tab===t.id?'on':''}" onclick="sTab('${t.id}')">${t.l}${t.b?`<span class="tbadge">${t.b}</span>`:''}</button>`).join('');
  document.getElementById('cinarea').style.display=S.tab==='chat'?'block':'none';
  const b=document.getElementById('pbody');
  if(S.tab==='analysis')rAnalysis(b);else if(S.tab==='signals')rSignals(b);else if(S.tab==='chat')rChat(b);else rKB(b);
}
function sTab(t){S.tab=t;rPanel()}

function rAnalysis(b){
  if(!S.analysis){b.innerHTML=`<div style="text-align:center;padding:24px 12px"><div style="font-size:32px;margin-bottom:6px">ğŸ“Š</div><div style="font-size:11px;font-weight:600;color:var(--text2)">No Analysis Yet</div><div style="font-size:8px;color:var(--text3);margin-top:3px">Click Analyze to scan ${S.sym.sh} with <strong>real candle data</strong></div><button class="abtn" onclick="analyze()" style="margin:10px auto 0;padding:6px 16px;font-size:9px">ğŸ” Run Analysis</button></div>`;return}
  const a=S.analysis;
  b.innerHTML=`
    <div class="bcard ${a.bias==='Bullish'?'bull':a.bias==='Bearish'?'bear':''}">
      <div style="display:flex;justify-content:space-between;margin-bottom:5px">
        <div style="display:flex;align-items:center;gap:5px"><span style="font-size:14px">${a.bias==='Bullish'?'ğŸŸ¢':a.bias==='Bearish'?'ğŸ”´':'âšª'}</span><div><div style="font-size:13px;font-weight:800;color:${a.bias==='Bullish'?'var(--green)':a.bias==='Bearish'?'var(--red)':'var(--text2)'};font-family:'Instrument Sans',sans-serif">${a.bias.toUpperCase()}</div><div style="font-size:7px;color:var(--text3)">${S.sym.sh} â€¢ ${TFS.find(t=>t.v===S.tf)?.l} â€¢ ${a.sess.n} ${S.dataLive?'â€¢ ğŸ“¡':'â€¢ âš ï¸'}</div></div></div>
        <div style="text-align:right"><div style="font-size:18px;font-weight:800;font-family:'DM Mono',monospace;color:${a.conf>=80?'var(--green)':a.conf>=65?'var(--yellow)':'var(--text2)'}">${a.conf}%</div><div style="font-size:6px;color:var(--text3)">CONFIDENCE</div></div>
      </div>
      <div style="font-size:8px;color:var(--text2);padding:3px 5px;background:rgba(0,0,0,.1);border-radius:3px">ğŸ“ ${a.structure} â€¢ ${Fc(a.price)}</div>
    </div>
    ${a.trade?`<div class="tcard"><div style="font-size:8px;font-weight:700;color:#b8a9ff;margin-bottom:6px">âš¡ ${a.trade.model}</div><div class="g2">
      <div class="sc" style="border:1px solid ${a.trade.dir==='LONG'?'rgba(0,212,170,.1)':'rgba(255,71,87,.1)'}"><div class="sl">DIR</div><div class="sv" style="color:${a.trade.dir==='LONG'?'var(--green)':'var(--red)'}">${a.trade.dir}</div></div>
      <div class="sc" style="border:1px solid var(--border)"><div class="sl">R:R</div><div class="sv" style="color:#b8a9ff">${a.trade.rr}</div></div>
      ${[{l:'ENTRY',v:a.trade.entry,c:'var(--text1)'},{l:'STOP LOSS',v:a.trade.sl,c:'var(--red)'},{l:'TP1',v:a.trade.tp1,c:'var(--green)'},{l:'TP2',v:a.trade.tp2,c:'var(--blue)'}].map(x=>`<div class="sc"><div class="sl">${x.l}</div><div class="sv" style="color:${x.c}">${x.v}</div></div>`).join('')}
    </div><div style="margin-top:4px;font-size:7px;color:var(--text3);padding:3px 5px;background:rgba(0,0,0,.1);border-radius:3px">ğŸ›¡ Risk: ${a.trade.risk} â€¢ SL beyond sweep/OB</div></div>`
    :'<div style="padding:6px;text-align:center;font-size:8px;color:var(--text3);border:1px dashed var(--border);border-radius:5px;margin-bottom:6px">â³ No trade â€” insufficient confluence</div>'}
    <div style="font-size:8px;font-weight:700;color:var(--text2);margin-bottom:4px">ğŸ” DETECTIONS (${a.dets.length})</div>
    ${a.dets.map((d,i)=>`<div class="dcard ${d.p} fade-up" style="animation-delay:${i*40}ms"><span style="font-size:10px">${d.i}</span><div style="flex:1"><div style="display:flex;justify-content:space-between"><span style="font-weight:700;color:var(--text1)">${d.t}</span><span style="font-size:5px;padding:1px 3px;border-radius:2px;font-weight:800;${d.p==='critical'?'background:rgba(255,71,87,.1);color:var(--red)':d.p==='high'?'background:rgba(108,92,231,.1);color:var(--accent)':'background:rgba(138,135,160,.08);color:var(--text2)'}">${d.p.toUpperCase()}</span></div><div style="color:var(--text2);margin-top:1px">${d.d}</div></div></div>`).join('')}`;
}

function rSignals(b){
  if(!S.notifs.length){b.innerHTML=`<div style="text-align:center;padding:24px"><div style="font-size:28px;margin-bottom:5px">ğŸ””</div><div style="font-size:10px;color:var(--text3)">No signals â€” run analysis to generate</div></div>`;return}
  b.innerHTML=`<div style="display:flex;justify-content:space-between;margin-bottom:5px"><span style="font-size:9px;font-weight:700;color:#b8a9ff">Signals (${S.notifs.length})</span><button onclick="S.notifs.forEach(n=>n.read=true);updNC();rPanel()" style="padding:2px 5px;border-radius:2px;border:1px solid var(--border);background:transparent;color:var(--accent);font-size:6px;cursor:pointer;font-family:inherit">Read all</button></div>
  ${S.notifs.map(n=>`<div class="sigcard ${n.read?'read':'unread'} hover-row" onclick="n=S.notifs.find(x=>x.id===${n.id});if(n)n.read=true;updNC();rPanel()"><div style="display:flex;justify-content:space-between;margin-bottom:3px"><div style="display:flex;align-items:center;gap:3px"><span style="font-size:10px">${n.dir==='LONG'?'ğŸŸ¢':'ğŸ”´'}</span><span style="font-size:10px;font-weight:800;color:${n.dir==='LONG'?'var(--green)':'var(--red)'};font-family:'DM Mono',monospace">${n.dir} ${n.sym}</span></div><span style="font-size:9px;font-weight:700;color:${n.conf>=80?'var(--green)':'var(--yellow)'};font-family:'DM Mono',monospace">${n.conf}%</span></div><div style="font-size:7px;color:var(--accent);font-weight:600;margin-bottom:3px">âš¡ ${n.model}</div><div class="g4">${[{l:'ENTRY',v:n.entry,c:'var(--text1)'},{l:'SL',v:n.sl,c:'var(--red)'},{l:'TP1',v:n.tp1,c:'var(--green)'},{l:'TP2',v:n.tp2,c:'var(--blue)'}].map(x=>`<div style="text-align:center;padding:2px;background:rgba(0,0,0,.15);border-radius:2px"><div style="font-size:5px;color:var(--text3)">${x.l}</div><div style="font-size:8px;font-weight:600;color:${x.c};font-family:'DM Mono',monospace">${x.v}</div></div>`).join('')}</div><div style="font-size:6px;color:var(--text3);margin-top:2px">${n.time.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} â€¢ R:R ${n.rr}</div></div>`).join('')}`;
}

function rChat(b){
  if(!S.msgs.length){b.innerHTML=`<div style="text-align:center;padding:10px 5px"><div style="font-size:20px;margin-bottom:4px">ğŸ¤–</div><div style="font-size:9px;font-weight:600;color:var(--text2)">ICT/SMC Live AI</div><div style="font-size:7px;color:var(--text3);margin:2px 0 8px">Ask about live chart, trade setups, or ICT concepts</div><div style="display:flex;flex-direction:column;gap:2px">${["Give me a trade plan","Should I enter now?","What's the market bias?","Show me the FVGs","Where are the order blocks?","What's the fib level?","What is a Fair Value Gap?","Explain OTE entry"].map(p=>`<button class="cprom" onclick="sendChat('${p}')">${p}</button>`).join('')}</div></div>`;return}
  b.innerHTML=S.msgs.map(m=>`<div class="cmsg"><div style="display:flex;align-items:center;gap:3px;margin-bottom:2px"><span style="font-size:7px">${m.r==='user'?'ğŸ‘¤':'ğŸ¤–'}</span><span style="font-size:6px;font-weight:600;color:${m.r==='user'?'var(--blue)':'var(--accent)'}">${m.r==='user'?'You':'SMC AI'}</span></div><div class="cbub ${m.r==='user'?'usr':'ai'}">${fmtC(m.c)}</div></div>`).join('')+(S.typing?'<div style="padding:6px 8px;font-size:8px;color:var(--accent)"><span style="animation:pulse 1s infinite">â³ Analyzing live data...</span></div>':'');
  b.scrollTop=b.scrollHeight;
}
function fmtC(t){return t.replace(/\*\*(.*?)\*\*/g,'<strong style="color:var(--text1)">$1</strong>').replace(/__(.*?)__/g,'<span style="color:var(--green);font-weight:700">$1</span>').replace(/~~(.*?)~~/g,'<span style="color:var(--red);font-weight:700">$1</span>').replace(/\^\^(.*?)\^\^/g,'<span style="color:var(--accent);font-weight:600">$1</span>').replace(/\n/g,'<br>')}

async function sendChat(txt){
  const msg=txt||document.getElementById('cinp').value.trim();if(!msg)return;document.getElementById('cinp').value='';
  S.msgs.push({r:'user',c:msg});S.typing=true;rPanel();
  const m=msg.toLowerCase();
  const isTradePlan=m.includes('trade plan')||m.includes('trade setup')||m.includes('give me')||m.includes('the trade')||m.includes('the setup')||m.includes('my trade')||m.includes('plan for')||m.includes('what trade');
  const isEntry=m.includes('should i enter')||m.includes('enter now')||m.includes('can i enter')||m.includes('is it safe')||m.includes('go long')||m.includes('go short')||m.includes('take the trade');
  const isBias=m.includes('bias')||m.includes('direction')||m.includes('trend')||m.includes('bullish or bearish')||m.includes('which way');
  const isFVG=m.includes('fvg')||m.includes('fair value gap')||m.includes('imbalance')||m.includes('show me the gap');
  const isOB=m.includes('order block')||m.match(/\bob\b/)||m.includes('institutional zone');
  const isFib=m.includes('fib')||m.includes('retracement')||m.includes('fibonacci')||m.includes('ote zone')||m.includes('ote level');
  const isSweep=m.includes('sweep')||m.includes('liquidity')||m.includes('stop hunt')||m.includes('bsl')||m.includes('ssl');
  const isSession=m.includes('session')||m.includes('kill zone')||m.includes(' kz')||m.includes('timing')||m.includes('when to trade');
  const isPrice=m.includes('current price')||m.includes('where is price')||m.includes('price now');
  const isLive=isTradePlan||isEntry||isBias||isFVG||isOB||isFib||isSweep||isSession||isPrice;
  if(isLive&&S.candles.length<20){await fetchLiveData();if(S.candles.length>=20){S.ict=analyzeCandles(S.candles);S.fib=calcFib(S.candles);showFib()}}
  if(isTradePlan||isEntry){await fetchLiveData();if(S.candles.length>=20){S.ict=analyzeCandles(S.candles);S.fib=calcFib(S.candles);S.analysis=S.ict;showFib()}}
  let resp;
  if(isTradePlan)resp=buildTradePlan();else if(isEntry)resp=buildEntryCheck();else if(isBias)resp=buildBiasReport();else if(isFVG)resp=buildFVGReport();else if(isOB)resp=buildOBReport();else if(isFib)resp=buildFibReport();else if(isSweep)resp=buildSweepReport();else if(isSession)resp=buildSessionReport();else if(isPrice)resp=buildPriceReport();else resp=buildKBResponse(m);
  setTimeout(()=>{S.typing=false;S.msgs.push({r:'ai',c:resp});rPanel()},isTradePlan||isEntry?800:350);
}
function buildTradePlan(){
  const A=S.ict,fi=S.fib,p=S.livePrice,sess=getSess();
  if(!A||!S.candles.length)return'âš ï¸ No live data available. Click **Analyze** first or wait for data to load.';
  let plan='';
  plan+=`**â•â•â• ICT/SMC TRADE PLAN â•â•â•**\n**${S.sym.sh}** | ${TFS.find(t=>t.v===S.tf)?.l} | ${S.dataLive?'ğŸ“¡ LIVE DATA':'âš ï¸ OFFLINE'}\nPrice: **${Fc(p)}** | ${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} EST\n\n`;
  plan+=`**ğŸ“ MARKET STRUCTURE**\nBias: ${A.bias==='Bullish'?'__'+A.bias+'__':A.bias==='Bearish'?'~~'+A.bias+'~~':'âšª '+A.bias} (${A.conf}% confidence)\n${A.structure}\n`;
  if(A.bos)plan+=`BOS: ${A.bos.type==='bull'?'Bullish':'Bearish'} break at ${Fc(A.bos.level)}\n`;
  plan+='\n';
  plan+=`**ğŸ” ICT PATTERNS (${A.dets.length})**\n`;
  if(A.fvgs.length){const r=A.fvgs.slice(-3);plan+=`ğŸ“Š FVGs (${A.fvgs.length}): ${r.map(f=>`${f.type==='bull'?'ğŸŸ¢':'ğŸ”´'} ${Fc(f.bot)}â€“${Fc(f.top)} [CE: ${Fc(f.mid)}]`).join(' | ')}\n`}else plan+='ğŸ“Š FVGs: None\n';
  if(A.obs.length){const r=A.obs.slice(-2);plan+=`ğŸ§± OBs (${A.obs.length}): ${r.map(o=>`${o.type==='bull'?'ğŸŸ¢':'ğŸ”´'} ${Fc(o.lo)}â€“${Fc(o.hi)} (${o.strength}x disp)`).join(' | ')}\n`}else plan+='ğŸ§± OBs: None\n';
  if(A.sweeps.length)plan+=`ğŸ’§ Sweeps: ${A.sweeps.map(s=>`${s.type==='bsl'?'BSL':'SSL'} at ${Fc(s.level)} â†’ ${Fc(s.wick)}`).join(' | ')}\n`;
  if(A.disp)plan+=`âš¡ Displacement: ${A.disp.dir==='bull'?'Bullish':'Bearish'} (${A.disp.strength} candles)\n`;
  if(A.eqHL.length)plan+=`âš–ï¸ Liq Pools: ${A.eqHL.slice(-2).map(e=>`${e.type==='eqh'?'EQH':'EQL'} at ${Fc(e.level)}`).join(' | ')}\n`;
  plan+='\n';
  if(fi){plan+=`**ğŸ“ FIBONACCI**\nSwing: ${Fc(fi.sH)} â†’ ${Fc(fi.sL)} | ${fi.pct}% retrace${fi.inOTE?' â€” ^^IN OTE ZONE^^':''}\n0.5=${Fc(fi.levels[3].price)} | **0.618=${Fc(fi.levels[4].price)}** | 0.786=${Fc(fi.levels[6].price)}\n\n`}
  if(A.pd){plan+=`**ğŸ’° ZONE:** ${A.pd.zone==='discount'?'__DISCOUNT__':'~~PREMIUM~~'} (${A.pd.pct}%) | EQ: ${Fc(A.pd.eq)}\n\n`}
  plan+=`**ğŸ• SESSION:** ${sess.n} â€” ${sess.p}${sess.kz?' | ^^KZ ACTIVE^^':''}\n\n`;
  if(A.trade){
    plan+=`**â•â•â• TRADE SETUP â•â•â•**\n`;
    plan+=`Direction: ${A.trade.dir==='LONG'?'__ğŸŸ¢ LONG__':'~~ğŸ”´ SHORT~~'} | Model: **${A.trade.model}**\n\n`;
    plan+=`**Entry:** ^^${A.trade.entry}^^`;
    if(A.fvgs.length){const f=A.fvgs[A.fvgs.length-1];plan+=` (${f.type} FVG mid at ${Fc(f.mid)})`}
    else if(A.obs.length){const o=A.obs[A.obs.length-1];plan+=` (${o.type} OB ${Fc(o.lo)}â€“${Fc(o.hi)})`}
    plan+='\n';
    plan+=`**Stop Loss:** ~~${A.trade.sl}~~`;
    if(A.sweeps.length)plan+=` (beyond ${A.sweeps[A.sweeps.length-1].type} sweep wick ${Fc(A.sweeps[A.sweeps.length-1].wick)})`;
    plan+='\n';
    plan+=`**TP1:** __${A.trade.tp1}__ (2R) | **TP2:** __${A.trade.tp2}__ (${A.trade.rr})\n`;
    plan+=`**R:R:** ${A.trade.rr} | **Risk:** ${A.trade.risk}\n\n`;
    plan+=`**ğŸ“‹ CONFLUENCE**\n`;
    plan+=`${A.sweeps.length?'âœ…':'âŒ'} Liquidity Sweep${A.sweeps.length?' ('+A.sweeps[A.sweeps.length-1].type+' at '+Fc(A.sweeps[A.sweeps.length-1].level)+')':''}\n`;
    plan+=`${A.disp?'âœ…':'âŒ'} Displacement${A.disp?' ('+A.disp.dir+', '+A.disp.strength+'x)':''}\n`;
    plan+=`${A.fvgs.length?'âœ…':'âŒ'} FVG${A.fvgs.length?' ('+A.fvgs.length+' found)':''}\n`;
    plan+=`${A.obs.length?'âœ…':'âŒ'} Order Block${A.obs.length?' ('+A.obs.length+' found)':''}\n`;
    plan+=`${fi?.inOTE?'âœ…':'âŒ'} OTE Zone${fi?' ('+fi.pct+'%)':''}\n`;
    plan+=`${sess.kz?'âœ…':'âš ï¸'} Kill Zone (${sess.n})\n`;
    plan+=`${A.bias!=='Neutral'?'âœ…':'âŒ'} Clear Bias (${A.bias})\n\n`;
    const checks=[A.sweeps.length,A.disp,A.fvgs.length||A.obs.length,fi?.inOTE,sess.kz,A.bias!=='Neutral'].filter(Boolean).length;
    plan+=`**Score: ${checks}/6** â€” ${checks>=5?'^^STRONG â€” High probability^^':checks>=4?'^^DECENT â€” Acceptable^^':checks>=3?'Developing â€” wait':'âš ï¸ WEAK â€” no trade'}\n\n`;
    plan+=`**ğŸ’¡ WHY:** `;
    if(A.sweeps.length&&A.disp)plan+=`Institutions swept ${A.sweeps[A.sweeps.length-1].type} at ${Fc(A.sweeps[A.sweeps.length-1].level)} then displaced ${A.disp.dir} â€” classic manipulationâ†’expansion. `;
    if(A.fvgs.length)plan+=`FVG at ${Fc(A.fvgs[A.fvgs.length-1].bot)}â€“${Fc(A.fvgs[A.fvgs.length-1].top)} created during displacement â€” expect price to fill at CE. `;
    if(fi?.inOTE)plan+=`Price in OTE (${fi.pct}%) â€” optimal entry. `;
    if(A.pd)plan+=`${A.pd.zone} zone (${A.pd.pct}%) ${A.pd.zone==='discount'?'favors longs':'favors shorts'}. `;
    if(sess.kz)plan+=`${sess.n} active â€” peak institutional volume.`;
  }else{
    plan+=`**â•â•â• NO TRADE â•â•â•**\nInsufficient confluence:\n`;
    if(!A.sweeps.length)plan+='âŒ No liquidity sweep\n';
    if(!A.disp)plan+='âŒ No displacement\n';
    if(!A.fvgs.length&&!A.obs.length)plan+='âŒ No FVG/OB\n';
    if(fi&&!fi.inOTE)plan+=`âŒ Not in OTE (${fi.pct}%)\n`;
    if(!sess.kz)plan+=`âš ï¸ No Kill Zone\n`;
    plan+='\n**Wait for:** Sweep â†’ Displacement â†’ FVG â†’ OTE retrace â†’ KZ timing';
  }
  return plan;
}
function buildEntryCheck(){
  const A=S.ict,fi=S.fib,p=S.livePrice,sess=getSess();
  if(!A)return'âš ï¸ No analysis data. Run **Analyze** first.';
  const hasSweep=A.sweeps.length>0,hasDisp=A.disp!==null,hasFVG=A.fvgs.length>0,hasOB=A.obs.length>0,inOTE=fi?.inOTE||false,kz=sess.kz,clearBias=A.bias!=='Neutral';
  const score=[hasSweep,hasDisp,hasFVG||hasOB,inOTE,kz,clearBias].filter(Boolean).length;
  let r=`**Enter ${S.sym.sh}?** Price: ${Fc(p)} | ${A.bias} ${A.conf}%\n\n`;
  r+=`${hasSweep?'âœ…':'âŒ'} Sweep${hasSweep?` â€” ${A.sweeps[A.sweeps.length-1].type} at ${Fc(A.sweeps[A.sweeps.length-1].level)}`:''}\n`;
  r+=`${hasDisp?'âœ…':'âŒ'} Displacement${hasDisp?` â€” ${A.disp.dir}, ${A.disp.strength}x`:''}\n`;
  r+=`${hasFVG?'âœ…':'âŒ'} FVG${hasFVG?` â€” ${Fc(A.fvgs[A.fvgs.length-1].bot)}â€“${Fc(A.fvgs[A.fvgs.length-1].top)}`:''}\n`;
  r+=`${hasOB?'âœ…':'âŒ'} OB${hasOB?` â€” ${Fc(A.obs[A.obs.length-1].lo)}â€“${Fc(A.obs[A.obs.length-1].hi)}`:''}\n`;
  r+=`${inOTE?'âœ…':'âŒ'} OTE${fi?` â€” ${fi.pct}%`:''}\n`;
  r+=`${kz?'âœ…':'âš ï¸'} Kill Zone (${sess.n})\n`;
  r+=`${clearBias?'âœ…':'âŒ'} Bias (${A.bias})\n\n`;
  r+=`**Score: ${score}/6** â€” `;
  if(score>=5)r+=`**^^YES â€” ENTER^^** ${A.trade?`${A.trade.dir} @ ${A.trade.entry}, SL ~~${A.trade.sl}~~, TP __${A.trade.tp1}__ / __${A.trade.tp2}__ (${A.trade.rr})`:''} Risk 1-2%.`;
  else if(score>=4)r+=`**^^CAUTIOUS YES^^** Decent setup, missing ${6-score}. ${A.trade?`${A.trade.dir} @ ${A.trade.entry}, R:R ${A.trade.rr}.`:''} Reduce to 0.5-1%.`;
  else if(score>=3)r+=`**âš ï¸ WAIT** â€” Developing. Need more confluence.`;
  else r+=`**~~NO~~** â€” Only ${score}/6. Do NOT enter.`;
  return r;
}
function buildBiasReport(){
  const A=S.ict,fi=S.fib,p=S.livePrice;if(!A)return'âš ï¸ No data.';
  let r=`**ğŸ“ BIAS: ${A.bias==='Bullish'?'__'+A.bias+'__':A.bias==='Bearish'?'~~'+A.bias+'~~':A.bias}** (${A.conf}%)\n${A.structure}\nPrice: ${Fc(p)}\n\n`;
  if(A.bos)r+=`ğŸ“ˆ BOS: ${A.bos.type} at ${Fc(A.bos.level)}\n`;
  if(A.disp)r+=`âš¡ Displacement: ${A.disp.dir} (${A.disp.strength}x)\n`;
  if(A.pd)r+=`ğŸ’° ${A.pd.zone} (${A.pd.pct}%)\n`;
  if(fi)r+=`ğŸ“ Fib: ${fi.pct}%${fi.inOTE?' ^^OTE^^':''}\n`;
  r+=`ğŸ• ${A.sess.n}${A.sess.kz?' ^^KZ^^':''}\n`;
  r+=`\n${A.bias==='Bullish'?'Look for longs at OBs/FVGs in discount.':A.bias==='Bearish'?'Look for shorts at OBs/FVGs in premium.':'Wait for structure.'}`;
  return r;
}
function buildFVGReport(){
  const A=S.ict,p=S.livePrice;if(!A)return'âš ï¸ No data.';
  if(!A.fvgs.length)return`ğŸ“Š **No FVGs** in ${S.candles.length} candles.`;
  let r=`ğŸ“Š **${A.fvgs.length} FVGs on ${S.sym.sh}**\n\n`;
  A.fvgs.slice(-5).forEach((f,i)=>{const near=Math.abs(p-f.mid)/p<0.003;r+=`${f.type==='bull'?'ğŸŸ¢':'ğŸ”´'} #${i+1}: **${Fc(f.bot)} â€” ${Fc(f.top)}** CE: ^^${Fc(f.mid)}^^${near?' â† __NEAR__':''}\n`});
  return r;
}
function buildOBReport(){
  const A=S.ict,p=S.livePrice;if(!A)return'âš ï¸ No data.';
  if(!A.obs.length)return'ğŸ§± **No Order Blocks.** Need 3+ displacement after opposing candle.';
  let r=`ğŸ§± **${A.obs.length} OBs on ${S.sym.sh}**\n\n`;
  A.obs.slice(-4).forEach((o,i)=>{const near=Math.abs(p-o.mid)/p<0.005;r+=`${o.type==='bull'?'ğŸŸ¢':'ğŸ”´'} #${i+1}: **${Fc(o.lo)} â€” ${Fc(o.hi)}** (${o.strength}x disp)${near?' â† __AT OB__':''}\n`});
  return r;
}
function buildFibReport(){
  const fi=S.fib;if(!fi)return'ğŸ“ Not enough data for Fibonacci.';
  showFib();document.getElementById('fib-panel').style.display='block';
  let r=`**ğŸ“ FIBONACCI**\nSwing: ${Fc(fi.sH)} â†’ ${Fc(fi.sL)} | Price: ${Fc(fi.price)} (${fi.pct}%)\n${fi.inOTE?'^^IN OTE ZONE^^':''}\n\n`;
  fi.levels.forEach(lv=>{const isOTE=lv.r>=0.5&&lv.r<=0.618;const near=Math.abs(fi.price-lv.price)/fi.range<0.025;r+=`${isOTE?'â˜…':near?'â†’':' '} **${lv.label}** = ^^${Fc(lv.price)}^^${isOTE?' OTE':''}${near?' â† HERE':''}\n`});
  r+=`\n**OTE:** ${Fc(fi.levels[3].price)} â€” ${Fc(fi.levels[4].price)} | Golden: ${Fc(fi.levels[4].price)}`;
  return r;
}
function buildSweepReport(){
  const A=S.ict;if(!A)return'âš ï¸ No data.';
  let r=`ğŸ’§ **LIQUIDITY â€” ${S.sym.sh}**\n\n`;
  if(A.sweeps.length){r+=`**Sweeps (${A.sweeps.length}):**\n`;A.sweeps.forEach(s=>r+=`${s.type==='bsl'?'ğŸ”´ BSL':'ğŸŸ¢ SSL'} at **${Fc(s.level)}** â†’ wick ~~${Fc(s.wick)}~~\n`);r+='\n'}else r+='No sweeps.\n\n';
  if(A.eqHL.length){r+=`**Pools:**\n`;A.eqHL.slice(-3).forEach(e=>r+=`âš–ï¸ ${e.type==='eqh'?'EQH (BSL)':'EQL (SSL)'} at ^^${Fc(e.level)}^^\n`)}
  return r;
}
function buildSessionReport(){
  const sess=getSess();
  return`**ğŸ• ${sess.n}** â€” ${sess.p}${sess.kz?' ^^KZ ACTIVE^^':''}\n\nğŸŒ Asian: 8PMâ€“3AM\nğŸ‡¬ğŸ‡§ **London KZ: 3â€“5AM**\nğŸ‡¬ğŸ‡§ London: 5â€“10AM\nğŸ‡ºğŸ‡¸ **NY KZ: 10AMâ€“12PM**\nğŸ½ Lunch: 12â€“1PM\nğŸ”« **Silver Bullet: 1â€“2PM**\nğŸ‡ºğŸ‡¸ NY PM: 2â€“5PM\n\n${sess.kz?'^^KZ active â€” prime for setups^^':'Wait for London/NY KZ for best entries.'}`;
}
function buildPriceReport(){
  const A=S.ict,p=S.livePrice;
  let r=`ğŸ’µ **${S.sym.sh}: ${Fc(p)}** ${S.dataLive?'ğŸ“¡':'âš ï¸'}\n`;
  if(A?.pd)r+=`${A.pd.zone==='discount'?'__DISCOUNT__':'~~PREMIUM~~'} (${A.pd.pct}%) EQ: ${Fc(A.pd.eq)}\n`;
  if(S.fib)r+=`Fib: ${S.fib.pct}%${S.fib.inOTE?' ^^OTE^^':''}\n`;
  if(A)r+=`Bias: ${A.bias} (${A.conf}%)`;
  return r;
}
function buildKBResponse(m){
  const all={...CONCEPTS,...TECHNIQUES};let resp='';
  for(const[name,content]of Object.entries(all)){
    if(name.toLowerCase().split(/[\s/()]+/).filter(w=>w.length>2).some(kw=>m.includes(kw))){resp+=`**${name}**\n${content}\n\n`;if(resp.length>400)break}
  }
  if(resp)return resp.trim()+'\n\nğŸ’¡ Try: **trade plan, should I enter, bias, FVG, OB, fib, sweep, session**';
  return'ğŸ¤– **I can answer:**\nâ€¢ "Give me a trade plan" â€” full ICT setup\nâ€¢ "Should I enter?" â€” confluence YES/NO\nâ€¢ "Bias?" â€” market structure\nâ€¢ "FVGs?" â€” Fair Value Gaps\nâ€¢ "OBs?" â€” Order Blocks\nâ€¢ "Fib?" â€” Fibonacci levels\nâ€¢ "Sweeps?" â€” liquidity analysis\nâ€¢ "Session?" â€” Kill Zone timing\nâ€¢ Or ask about any ICT concept!';
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATUS BAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updStatus(){
  const est=new Date().toLocaleTimeString('en-US',{timeZone:'America/New_York',hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const s=getSess();
  document.getElementById('stl').innerHTML=`SMC Terminal â€¢ ${S.dataLive?'<span style="color:var(--green)">ğŸ“¡ LIVE</span>':'<span style="color:var(--red)">âš  OFFLINE</span>'} â€¢ ${S.sym.sh}/${TFS.find(t=>t.v===S.tf)?.l} â€¢ ${S.candles.length} candles`;
  document.getElementById('str').innerHTML=`${s.i} ${s.n} â€¢ ${est} EST`;
  rSess();updPrice();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('click',e=>{if(!document.getElementById('symw').contains(e.target))document.getElementById('sdrop').classList.remove('open')});
rTF();rSess();loadChart();rPanel();updStatus();
setInterval(updStatus,5000);
startWatcher();
</script>
</body>
</html>
