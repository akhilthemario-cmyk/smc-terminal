<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SMC Terminal â€” Live ICT/SMC AI Analyst</title>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=DM+Mono:ital,wght@0,300;0,400;0,500;1,400&family=Instrument+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg0:#04040a;--bg1:#070710;--bg2:#0a0a16;--bg3:#0d0d1e;--bg4:#12122a;--accent:#6c5ce7;--accent2:#00cec9;--red:#ff4757;--green:#00d4aa;--yellow:#ffa502;--blue:#4da6ff;--text1:#e8e6f2;--text2:#8886a0;--text3:#4e4c64;--border:rgba(108,92,231,.1);--border2:rgba(108,92,231,.22)}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Manrope',sans-serif;background:var(--bg0);color:var(--text1);overflow:hidden;height:100vh}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(108,92,231,.2);border-radius:2px}
@keyframes fadeUp{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:.3}50%{opacity:1}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes slideR{from{opacity:0;transform:translateX(16px)}to{opacity:1;transform:translateX(0)}}
@keyframes breathe{0%,100%{box-shadow:0 0 6px rgba(108,92,231,.15)}50%{box-shadow:0 0 16px rgba(108,92,231,.35)}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
.fade-up{animation:fadeUp .25s ease-out backwards}
.hover-row:hover{background:rgba(108,92,231,.06)!important}.hover-row{transition:background .1s;cursor:pointer}
#app{display:flex;flex-direction:column;height:100vh}
#topbar{height:42px;min-height:42px;background:var(--bg1);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 10px;gap:6px;z-index:100}
#workspace{flex:1;display:flex;overflow:hidden}
#chart-col{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative}
#chart-wrap{flex:1;overflow:hidden;position:relative}
#ai-watcher{height:210px;min-height:210px;background:var(--bg1);border-top:1px solid var(--border2);display:flex;flex-direction:column;overflow:hidden;position:relative}
#ai-watcher::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),var(--accent2),transparent);opacity:.4}
#right-panel{width:360px;min-width:360px;background:var(--bg2);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
#statusbar{height:20px;min-height:20px;background:var(--bg0);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 10px;font-size:8px;color:var(--text3);font-family:'DM Mono',monospace}
.logo{display:flex;align-items:center;gap:6px;margin-right:4px}
.logo-i{width:24px;height:24px;border-radius:5px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;color:#fff}
.logo-t{font-size:11px;font-weight:700;font-family:'Instrument Sans',sans-serif}
.logo-s{font-size:7px;color:var(--accent);letter-spacing:1px;margin-top:-1px}
.sep{width:1px;height:20px;background:var(--border);margin:0 2px}
.tb{padding:3px 9px;border-radius:4px;border:1px solid var(--border);background:rgba(108,92,231,.03);color:var(--text1);font-size:10px;font-weight:600;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:4px;transition:all .1s;white-space:nowrap}
.tb:hover{background:rgba(108,92,231,.07);border-color:var(--border2)}
.tfb{display:flex;gap:1px;background:rgba(108,92,231,.02);border-radius:4px;padding:1px}
.tf{padding:2px 6px;border-radius:3px;border:none;background:transparent;color:var(--text3);font-size:8px;font-weight:500;cursor:pointer;font-family:'DM Mono',monospace;transition:all .08s}
.tf.on{background:rgba(108,92,231,.18);color:#b8a9ff}.tf:hover{color:var(--text2)}
.sess{display:flex;align-items:center;gap:4px;padding:2px 8px;border-radius:4px;background:rgba(108,92,231,.02);border:1px solid var(--border);font-size:8px;font-weight:600}
.kzt{font-size:6px;background:rgba(0,212,170,.1);color:var(--green);padding:1px 3px;border-radius:2px;font-weight:800}
.abtn{padding:3px 12px;border-radius:4px;border:none;background:linear-gradient(135deg,var(--accent),#7c5cff);color:#fff;font-size:9px;font-weight:700;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:4px;transition:all .12s}
.abtn:hover{filter:brightness(1.1);transform:translateY(-1px)}.abtn:disabled{opacity:.4;cursor:wait}
.autob{padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:rgba(108,92,231,.02);color:var(--text2);font-size:8px;font-weight:700;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:4px;transition:all .1s}
.autob.on{border-color:rgba(0,212,170,.25);background:rgba(0,212,170,.05);color:var(--green)}
.adot{width:4px;height:4px;border-radius:50%;background:var(--text3)}.autob.on .adot{background:var(--green);animation:pulse 1.5s infinite}
.nbtn{width:28px;height:28px;border-radius:5px;border:1px solid var(--border);background:rgba(108,92,231,.02);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;position:relative}
.ncnt{position:absolute;top:-2px;right:-2px;min-width:13px;height:13px;border-radius:50%;background:var(--red);color:#fff;font-size:7px;font-weight:800;display:flex;align-items:center;justify-content:center;padding:0 2px}
.sdrop{position:absolute;top:36px;left:0;width:220px;background:var(--bg3);border:1px solid var(--border2);border-radius:7px;z-index:999;box-shadow:0 12px 40px rgba(0,0,0,.6);overflow:hidden;display:none}.sdrop.open{display:block}
.ssinp{width:100%;padding:7px 9px;border:none;border-bottom:1px solid var(--border);background:transparent;color:var(--text1);font-size:10px;outline:none;font-family:inherit}
.slist{max-height:240px;overflow-y:auto}
.si{padding:6px 10px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(108,92,231,.03);font-size:10px}.si.act{background:rgba(108,92,231,.1)}
.aw-head{display:flex;align-items:center;justify-content:space-between;padding:5px 10px;border-bottom:1px solid var(--border);background:var(--bg1)}
.aw-title{display:flex;align-items:center;gap:5px;font-size:9px;font-weight:700;font-family:'Instrument Sans',sans-serif}
.aw-eye{width:18px;height:18px;border-radius:4px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:9px;animation:breathe 3s infinite}
.aw-status{display:flex;align-items:center;gap:4px;font-size:7px;font-weight:600}
.aw-live{width:5px;height:5px;border-radius:50%;background:var(--green);animation:blink 2s infinite}
.aw-feed{flex:1;overflow-y:auto;padding:4px 8px}
.aw-msg{display:flex;gap:5px;margin-bottom:4px;animation:fadeUp .2s ease-out}
.aw-ts{font-size:7px;color:var(--text3);font-family:'DM Mono',monospace;min-width:34px;margin-top:2px}
.aw-ico{font-size:10px;margin-top:1px}
.aw-txt{font-size:8.5px;line-height:1.4;color:var(--text2);flex:1}
.aw-txt strong{color:var(--text1);font-weight:600}
.aw-txt .g{color:var(--green);font-weight:700}.aw-txt .r{color:var(--red);font-weight:700}.aw-txt .a{color:var(--accent);font-weight:600}.aw-txt .y{color:var(--yellow);font-weight:600}.aw-txt .b{color:var(--blue);font-weight:600}
.aw-alert{padding:4px 7px;border-radius:4px;margin-bottom:4px;border:1px solid;display:flex;gap:5px;align-items:flex-start;animation:slideR .3s ease-out}
.aw-alert.buy{background:rgba(0,212,170,.04);border-color:rgba(0,212,170,.18)}
.aw-alert.sell{background:rgba(255,71,87,.04);border-color:rgba(255,71,87,.18)}
.aw-alert.info{background:rgba(108,92,231,.04);border-color:rgba(108,92,231,.15)}
.ptabs{display:flex;border-bottom:1px solid var(--border);background:var(--bg1)}
.ptab{flex:1;padding:8px 3px;font-size:8px;font-weight:700;text-align:center;cursor:pointer;border:none;background:none;color:var(--text3);border-bottom:2px solid transparent;font-family:inherit;transition:all .1s;letter-spacing:.2px}
.ptab:hover{color:var(--text2);background:rgba(108,92,231,.04)}.ptab.on{color:#b8a9ff;border-bottom-color:var(--accent);background:rgba(108,92,231,.03)}
.tbadge{margin-left:2px;background:var(--red);color:#fff;font-size:6px;padding:1px 3px;border-radius:2px;font-weight:800}
.pbody{flex:1;overflow-y:auto;padding:8px}
.bcard{border-radius:7px;padding:10px;margin-bottom:7px}
.bcard.bull{background:rgba(0,212,170,.03);border:1px solid rgba(0,212,170,.12)}.bcard.bear{background:rgba(255,71,87,.03);border:1px solid rgba(255,71,87,.12)}
.tcard{background:rgba(108,92,231,.02);border:1px solid var(--border);border-radius:7px;padding:10px;margin-bottom:7px}
.dcard{padding:6px 7px;margin-bottom:3px;border-radius:5px;border:1px solid var(--border);display:flex;gap:5px;align-items:flex-start;font-size:8px}
.dcard.critical{background:rgba(255,71,87,.03);border-color:rgba(255,71,87,.12)}.dcard.high{background:rgba(108,92,231,.03);border-color:rgba(108,92,231,.08)}.dcard.medium{background:rgba(20,20,40,.25)}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:4px}
.sc{padding:4px 5px;border-radius:4px;background:rgba(0,0,0,.18);text-align:center}
.sl{font-size:7px;color:var(--text3);text-transform:uppercase;letter-spacing:.4px}
.sv{font-size:10px;font-weight:700;font-family:'DM Mono',monospace;margin-top:1px}
.sigcard{padding:8px;margin-bottom:5px;border-radius:6px;border:1px solid var(--border);animation:fadeUp .25s ease-out backwards}
.sigcard.unread{background:rgba(108,92,231,.04);border-color:var(--border2)}.sigcard.read{background:rgba(12,12,24,.3)}
.g4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:3px}
.cmsg{margin-bottom:8px;animation:fadeUp .2s ease-out}
.cbub{padding:7px 9px;border-radius:6px;font-size:9px;line-height:1.55}
.cbub.usr{background:rgba(77,166,255,.05);border:1px solid rgba(77,166,255,.08);color:#a5c8f0}
.cbub.ai{background:rgba(108,92,231,.03);border:1px solid rgba(108,92,231,.06);color:var(--text2)}
.cinw{padding:5px 8px;border-top:1px solid var(--border);display:flex;gap:5px}
.cinp{flex:1;padding:6px 7px;border-radius:5px;border:1px solid var(--border);background:rgba(108,92,231,.02);color:var(--text1);font-size:8px;outline:none;font-family:inherit}
.csnd{width:28px;height:28px;border-radius:5px;border:none;background:var(--accent);color:#fff;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.cprom{padding:4px 6px;border-radius:4px;border:1px solid var(--border);background:rgba(108,92,231,.02);color:var(--text2);font-size:7px;cursor:pointer;text-align:left;font-family:inherit;transition:all .1s}
.cprom:hover{background:rgba(108,92,231,.06);border-color:var(--border2)}
.kbi{padding:3px 5px;border-radius:3px;font-size:7px;color:var(--text2);display:flex;align-items:center;gap:3px}
.aov{position:absolute;inset:0;background:rgba(4,4,10,.55);backdrop-filter:blur(2px);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:50}.aov.show{display:flex}
.spinner{width:36px;height:36px;border-radius:50%;border:2px solid transparent;border-top-color:var(--accent);border-right-color:var(--accent2);animation:spin .7s linear infinite}
.toasts{position:fixed;top:50px;right:12px;width:290px;z-index:9999}
.toast{background:var(--bg3);border:1px solid var(--border2);border-radius:8px;padding:9px;margin-bottom:6px;animation:slideR .35s ease-out;box-shadow:0 8px 28px rgba(0,0,0,.5);position:relative}
.toast-x{position:absolute;top:4px;right:6px;background:none;border:none;color:var(--text3);cursor:pointer;font-size:10px}
.fib-bar{display:flex;gap:2px;flex-wrap:wrap;margin-top:3px}
.fib-lv{flex:1;min-width:62px;padding:2px 4px;border-radius:3px;text-align:center;font-size:7px}
.fib-lv .fl{color:var(--text3)}.fib-lv .fv{font-size:9px;font-weight:600;font-family:'DM Mono',monospace;margin-top:1px}
</style>
</head>
<body>
<div id="app">
<div id="topbar">
  <div class="logo"><div class="logo-i">S</div><div><div class="logo-t">SMC Terminal</div><div class="logo-s">ICT / SMART MONEY AI</div></div></div>
  <div class="sep"></div>
  <div style="position:relative" id="symw">
    <button class="tb" id="symbtn" onclick="toggleSym()">ğŸ“ˆ <span id="symlbl">XAU/USD</span> <span style="font-size:7px;color:var(--text3)">â–¼</span></button>
    <div class="sdrop" id="sdrop"><input class="ssinp" id="ssinp" placeholder="Search..." oninput="filterSym()"><div class="slist" id="slist"></div></div>
  </div>
  <div class="tfb" id="tfbar"></div>
  <div style="flex:1"></div>
  <div id="price-disp" style="font-family:'DM Mono',monospace;font-size:12px;font-weight:700;margin-right:6px"></div>
  <div class="sess" id="sessbdg"></div>
  <button class="autob" id="autob" onclick="toggleAuto()"><div class="adot"></div><span id="autolbl">AUTO</span></button>
  <button class="abtn" id="abtn" onclick="analyze()">ğŸ” Analyze</button>
  <button class="nbtn" onclick="void(0)">ğŸ””<div class="ncnt" id="ncnt" style="display:none">0</div></button>
</div>
<div id="workspace">
  <div id="chart-col">
    <div id="chart-wrap"></div>
    <div class="aov" id="aov"><div class="spinner"></div><div style="margin-top:8px;font-size:10px;color:#b8a9ff" id="scanst">Fetching live data...</div></div>
    <div id="ai-watcher">
      <div class="aw-head">
        <div class="aw-title"><div class="aw-eye">ğŸ‘</div> AI Watcher <span style="font-size:7px;color:var(--text2);font-weight:400">â€” Live ICT/SMC analysis</span></div>
        <div class="aw-status" id="aw-status"><div class="aw-live"></div><span style="color:var(--green)">WATCHING</span> <span id="aw-sym" style="color:var(--text2)">XAU/USD</span> <span id="data-badge" style="font-size:6px;padding:1px 3px;border-radius:2px;background:rgba(108,92,231,.1);color:var(--text3)">OFFLINE</span></div>
      </div>
      <div class="aw-feed" id="aw-feed"></div>
      <div id="fib-panel" style="display:none"></div>
      <div class="cinw">
        <input id="aw-inp" class="cinp" placeholder="Ask: bias? fib? FVG? should I enter? price?..." onkeydown="if(event.key==='Enter')askWatcher()">
        <button onclick="askWatcher()" class="csnd" style="font-size:9px">Ask</button>
      </div>
    </div>
  </div>
  <div id="right-panel">
    <div class="ptabs" id="ptabs"></div>
    <div class="pbody" id="pbody"></div>
    <div id="cinarea" style="display:none"><div class="cinw"><input class="cinp" id="cinp" placeholder="Ask about ICT/SMC..." onkeydown="if(event.key==='Enter')sendChat()"><button class="csnd" onclick="sendChat()">â†‘</button></div></div>
  </div>
</div>
<div id="statusbar"><div id="stl"></div><div id="str"></div></div>
</div>
<div class="toasts" id="toasts"></div>


<script>
"use strict";
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V5 â€” NUCLEAR PRICE FIX: nowPrice() is THE ONLY way to read price
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SYMS=[
  {s:"OANDA:XAUUSD",n:"Gold",sh:"XAU/USD",yf:"GC=F"},
  {s:"OANDA:EURUSD",n:"EUR/USD",sh:"EUR/USD",yf:"EURUSD=X"},
  {s:"OANDA:GBPUSD",n:"GBP/USD",sh:"GBP/USD",yf:"GBPUSD=X"},
  {s:"FX:USDJPY",n:"USD/JPY",sh:"USD/JPY",yf:"JPY=X"},
  {s:"OANDA:GBPJPY",n:"GBP/JPY",sh:"GBP/JPY",yf:"GBPJPY=X"},
  {s:"BITSTAMP:BTCUSD",n:"Bitcoin",sh:"BTC/USD",yf:"BTC-USD"},
  {s:"BITSTAMP:ETHUSD",n:"Ethereum",sh:"ETH/USD",yf:"ETH-USD"},
  {s:"NASDAQ:AAPL",n:"Apple",sh:"AAPL",yf:"AAPL"},
  {s:"NASDAQ:TSLA",n:"Tesla",sh:"TSLA",yf:"TSLA"},
  {s:"SP:SPX",n:"S&P 500",sh:"SPX",yf:"^GSPC"},
  {s:"OANDA:NAS100USD",n:"NASDAQ 100",sh:"NAS100",yf:"^NDX"},
  {s:"TVC:DXY",n:"Dollar Index",sh:"DXY",yf:"DX-Y.NYB"},
  {s:"OANDA:USOIL",n:"Crude Oil",sh:"WTI",yf:"CL=F"},
  {s:"OANDA:XAGUSD",n:"Silver",sh:"XAG/USD",yf:"SI=F"}
];
const TFS=[{v:"1",l:"1m"},{v:"5",l:"5m"},{v:"15",l:"15m"},{v:"30",l:"30m"},{v:"60",l:"1H"},{v:"240",l:"4H"},{v:"D",l:"1D"},{v:"W",l:"1W"}];
const PREF={'OANDA:XAUUSD':3320,'OANDA:EURUSD':1.085,'OANDA:GBPUSD':1.265,'FX:USDJPY':149.5,'OANDA:GBPJPY':189,'BITSTAMP:BTCUSD':107000,'BITSTAMP:ETHUSD':2600,'NASDAQ:AAPL':225,'NASDAQ:TSLA':340,'SP:SPX':5700,'OANDA:NAS100USD':20500,'TVC:DXY':104,'OANDA:USOIL':62,'OANDA:XAGUSD':33};

let $={sym:SYMS[0],tf:"15",analysis:null,busy:false,auto:false,autoI:null,notifs:[],tab:"analysis",msgs:[],typing:false,wI:null,wCyc:0,candles:[],dataLive:false,dataI:null,fib:null,ict:null,prevDayClose:0,tickPrice:null,lastFetchMs:0,pxSrc:'init'};

// â•â•â• PRICE FIX v4: Bulletproof with debug â•â•â•
// tickPrice = null means "no data yet" (not 0!)
// Source tracking: $.pxSrc tells us WHERE the price came from
function nowPrice(){
  // 1. Yahoo tick price (from meta.regularMarketPrice) â€” most accurate
  if($.tickPrice!==null&&$.tickPrice>0){$.pxSrc='tick';return $.tickPrice}
  // 2. Last candle close
  if($.candles.length>0){$.pxSrc='candle';return $.candles[$.candles.length-1].c}
  // 3. Reference fallback (only before first fetch)
  $.pxSrc='ref';return PREF[$.sym.s]||100;
}
function P(v){if(v==null||isNaN(v))return'â€”';const b=nowPrice()||100;return b<10?v.toFixed(4):b<200?v.toFixed(2):b<2000?v.toFixed(1):v.toFixed(0)}
function Pc(v){const s=P(v);if(s==='â€”')return s;return Number(s).toLocaleString('en-US',{minimumFractionDigits:s.includes('.')?s.split('.')[1].length:0})}

// â•â•â• SESSION â•â•â•
function getSess(){
  const h=(new Date().getUTCHours()-5+24)%24,mn=new Date().getUTCMinutes(),hm=h+mn/60;
  if(hm>=20||hm<3)return{n:"Asian",p:"Accumulation",i:"ğŸŒ",c:"var(--yellow)",kz:false,sb:false};
  if(hm>=3&&hm<4)return{n:"London KZ",p:"SB 3-4AM",i:"ğŸ‡¬ğŸ‡§",c:"var(--red)",kz:true,sb:true};
  if(hm>=4&&hm<5)return{n:"London KZ",p:"Manipulation",i:"ğŸ‡¬ğŸ‡§",c:"var(--red)",kz:true,sb:false};
  if(hm>=5&&hm<10)return{n:"London",p:"Expansion",i:"ğŸ‡¬ğŸ‡§",c:"var(--blue)",kz:false,sb:false};
  if(hm>=10&&hm<11)return{n:"NY KZ",p:"SB 10-11AM",i:"ğŸ‡ºğŸ‡¸",c:"var(--green)",kz:true,sb:true};
  if(hm>=11&&hm<12)return{n:"NY KZ",p:"Expansion",i:"ğŸ‡ºğŸ‡¸",c:"var(--green)",kz:true,sb:false};
  if(hm>=12&&hm<13)return{n:"Lunch",p:"Avoid",i:"ğŸ½",c:"var(--text3)",kz:false,sb:false};
  if(hm>=13&&hm<14)return{n:"SB PM",p:"1-2PM",i:"ğŸ”«",c:"var(--accent)",kz:true,sb:true};
  if(hm>=14&&hm<17)return{n:"NY PM",p:"Continuation",i:"ğŸ‡ºğŸ‡¸",c:"var(--blue)",kz:false,sb:false};
  return{n:"Off Hours",p:"Wait",i:"â¸",c:"var(--text3)",kz:false,sb:false};
}

// â•â•â• LIVE DATA v4: Debug-traced, bulletproof price extraction â•â•â•
const PROXIES=['https://corsproxy.io/?url=','https://api.allorigins.win/raw?url='];
let proxyIdx=0;

async function fetchYahoo(yf,interval,range){
  const bust='&_t='+Date.now();
  for(let attempt=0;attempt<PROXIES.length;attempt++){
    const proxy=PROXIES[(proxyIdx+attempt)%PROXIES.length];
    const raw='https://query1.finance.yahoo.com/v8/finance/chart/'+yf+'?interval='+interval+'&range='+range+'&includePrePost=true'+bust;
    const url=proxy+encodeURIComponent(raw);
    try{
      const res=await fetch(url,{signal:AbortSignal.timeout(6000),cache:'no-store',headers:{'Cache-Control':'no-cache'}});
      if(!res.ok)continue;
      const j=await res.json();
      const r=j.chart?.result?.[0];
      if(!r?.timestamp)continue;
      proxyIdx=(proxyIdx+attempt)%PROXIES.length;
      return r;
    }catch(e){continue}
  }
  return null;
}

async function fetchLive(){
  const yf=$.sym.yf;
  console.log('[SMC] fetchLive for',yf);

  // STEP 1: 1m candles for price accuracy
  const r1m=await fetchYahoo(yf,'1m','2d');
  if(r1m){
    const metaPx=r1m.meta?.regularMarketPrice;
    if(metaPx&&metaPx>0){$.tickPrice=metaPx;$.lastFetchMs=Date.now();console.log('[SMC] tick(meta):',metaPx)}
    const ts=r1m.timestamp,q=r1m.indicators.quote[0];
    let last1m=null;
    for(let i=ts.length-1;i>=0;i--){if(q.close[i]!=null){last1m=q.close[i];break}}
    if(last1m!==null){
      console.log('[SMC] last1m close:',last1m);
      if($.tickPrice===null||Math.abs($.tickPrice-last1m)/last1m>0.02){$.tickPrice=last1m;$.lastFetchMs=Date.now();console.log('[SMC] tick OVERRIDDEN:',last1m)}
    }
    const td=new Date();td.setHours(0,0,0,0);
    for(let i=ts.length-1;i>=0;i--){if(ts[i]*1000<td.getTime()&&q.close[i]!=null){$.prevDayClose=q.close[i];break}}
  }

  // STEP 2: Analysis-TF candles
  const tfm={'1':'1m','5':'5m','15':'15m','30':'30m','60':'60m','240':'60m','D':'1d','W':'1wk'};
  const rm={'1':'1d','5':'2d','15':'5d','30':'5d','60':'10d','240':'30d','D':'6mo','W':'1y'};
  const rTF=await fetchYahoo(yf,tfm[$.tf]||'15m',rm[$.tf]||'5d');
  if(rTF){
    const ts=rTF.timestamp,q=rTF.indicators.quote[0],cc=[];
    for(let i=0;i<ts.length;i++){
      if(q.open[i]==null||q.close[i]==null)continue;
      cc.push({t:ts[i]*1000,o:q.open[i],h:q.high[i]||q.open[i],l:q.low[i]||q.open[i],c:q.close[i],v:q.volume?.[i]||0});
    }
    $.candles=cc.slice(-100);
    console.log('[SMC] candles:',$.candles.length,'lastClose:',$.candles.length?$.candles[$.candles.length-1].c:'none');
    if($.tickPrice===null&&rTF.meta?.regularMarketPrice>0){$.tickPrice=rTF.meta.regularMarketPrice;$.lastFetchMs=Date.now()}
  }

  if($.tickPrice===null&&$.candles.length){$.tickPrice=$.candles[$.candles.length-1].c;$.lastFetchMs=Date.now();console.log('[SMC] tick from TF candle:',$.tickPrice)}

  const ok=($.candles.length>0||$.tickPrice!==null);
  $.dataLive=ok;
  const b=document.getElementById('data-badge');
  if(ok){b.textContent='LIVE';b.style.background='rgba(0,212,170,.12)';b.style.color='var(--green)'}
  else{b.textContent='OFFLINE';b.style.background='rgba(255,71,87,.1)';b.style.color='var(--red)'}
  console.log('[SMC] FINAL tick=',$.tickPrice,'src=',$.pxSrc,'candles=',$.candles.length);
  return ok;
}

async function tickRefresh(){
  const yf=$.sym.yf;
  try{
    const proxy=PROXIES[proxyIdx%PROXIES.length];
    const url=proxy+encodeURIComponent('https://query1.finance.yahoo.com/v8/finance/chart/'+yf+'?interval=1m&range=1d&includePrePost=true&_t='+Date.now());
    const res=await fetch(url,{signal:AbortSignal.timeout(5000),cache:'no-store'});
    if(!res.ok)return;
    const j=await res.json(),r=j.chart?.result?.[0];
    if(!r)return;
    const metaPx=r.meta?.regularMarketPrice;
    let last1m=null;
    if(r.timestamp&&r.indicators?.quote?.[0]){const q=r.indicators.quote[0];for(let i=r.timestamp.length-1;i>=0;i--){if(q.close[i]!=null){last1m=q.close[i];break}}}
    const newPx=metaPx>0?metaPx:last1m;
    if(newPx&&newPx>0){$.tickPrice=newPx;$.lastFetchMs=Date.now();updPx()}
  }catch(e){}
}

function startFeed(){
  if($.dataI)clearInterval($.dataI);
  if($.tickI)clearInterval($.tickI);
  $.tickPrice=null;$.pxSrc='init';
  fetchLive().then(ok=>{
    if(ok)awM('s',`ğŸ“¡ <strong>Live:</strong> <span class="a">${$.sym.sh}</span> ${$.candles.length}c. Price: <span class="g">${Pc(nowPrice())}</span> <span style="font-size:7px;color:var(--text3)">[src:${$.pxSrc}]</span>`);
    else awM('s',`âš ï¸ Offline for ${$.sym.sh}.`);
  });
  $.dataI=setInterval(()=>fetchLive().then(()=>updPx()),20000);
  $.tickI=setInterval(tickRefresh,6000);
}

// â•â•â• SWING DETECTION â•â•â•
function findSw(c,lb){
  lb=lb||3;const H=[],L=[];
  for(let i=lb;i<c.length-lb;i++){
    let isH=true,isL=true;
    for(let j=1;j<=lb;j++){if(c[i].h<=c[i-j].h||c[i].h<=c[i+j].h)isH=false;if(c[i].l>=c[i-j].l||c[i].l>=c[i+j].l)isL=false}
    if(isH)H.push({p:c[i].h,i:i,t:c[i].t});if(isL)L.push({p:c[i].l,i:i,t:c[i].t});
  }
  return{H,L};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CORE ICT ANALYSIS â€” all prices come from candle array c
// No caching of price â€” everything is computed fresh
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ictAnalyze(){
  const c=$.candles;
  if(c.length<20)return null;
  // CRITICAL: price read directly from last candle RIGHT NOW
  // CRITICAL: use nowPrice() (live tick) for ALL price comparisons,
  // NOT the last candle close which can be minutes stale
  const px=nowPrice();
  const sw=findSw(c,3);
  const A={px,fvgs:[],obs:[],brk:[],mit:[],bos:null,choch:null,sweeps:[],eqHL:[],bias:'Neutral',str:'',disp:null,pd:null,ote:null,ndog:null,mmbm:null,mmsm:null,sess:getSess(),dets:[],conf:35,trade:null};

  // â”€â”€ Bias â”€â”€
  if(sw.H.length>=2&&sw.L.length>=2){
    const lh=sw.H.slice(-4),ll=sw.L.slice(-4);
    let hh=0,lhc=0,hl=0,llc=0;
    for(let i=1;i<lh.length;i++){if(lh[i].p>lh[i-1].p)hh++;else lhc++}
    for(let i=1;i<ll.length;i++){if(ll[i].p>ll[i-1].p)hl++;else llc++}
    if(hh>lhc&&hl>llc){A.bias='Bullish';A.str='HH('+hh+')+HL('+hl+')'}
    else if(lhc>hh&&llc>hl){A.bias='Bearish';A.str='LH('+lhc+')+LL('+llc+')'}
    else A.str='Mixed â€” ranging';
  }

  // â”€â”€ FVGs â”€â”€
  for(let i=1;i<c.length-1;i++){
    if(c[i-1].h<c[i+1].l)A.fvgs.push({ty:'bull',top:c[i+1].l,bot:c[i-1].h,mid:(c[i+1].l+c[i-1].h)/2,ix:i});
    if(c[i-1].l>c[i+1].h)A.fvgs.push({ty:'bear',top:c[i-1].l,bot:c[i+1].h,mid:(c[i-1].l+c[i+1].h)/2,ix:i});
  }

  // â”€â”€ Order Blocks â”€â”€
  const ab=c.slice(-20).reduce((s,x)=>s+Math.abs(x.c-x.o),0)/20;
  for(let i=1;i<c.length-3;i++){
    let br=0,be=0;
    for(let j=i;j<Math.min(i+4,c.length);j++){
      if(c[j].c>c[j].o&&Math.abs(c[j].c-c[j].o)>ab*1.3)br++;
      if(c[j].c<c[j].o&&Math.abs(c[j].c-c[j].o)>ab*1.3)be++;
    }
    if(br>=3&&c[i-1].c<c[i-1].o)A.obs.push({ty:'bull',hi:c[i-1].h,lo:c[i-1].l,mid:(c[i-1].h+c[i-1].l)/2,ix:i-1,st:br});
    if(be>=3&&c[i-1].c>c[i-1].o)A.obs.push({ty:'bear',hi:c[i-1].h,lo:c[i-1].l,mid:(c[i-1].h+c[i-1].l)/2,ix:i-1,st:be});
  }

  // â”€â”€ Breaker Blocks â”€â”€
  for(const ob of A.obs){
    let broken=false;
    for(let j=ob.ix+1;j<c.length;j++){
      if(ob.ty==='bull'&&c[j].c<ob.lo){broken=true;break}
      if(ob.ty==='bear'&&c[j].c>ob.hi){broken=true;break}
    }
    if(broken){
      const bt=ob.ty==='bull'?'bear':'bull';
      A.brk.push({ty:bt,hi:ob.hi,lo:ob.lo,mid:ob.mid,touch:px>=ob.lo&&px<=ob.hi});
    }
  }

  // â”€â”€ Mitigation â”€â”€
  for(let i=5;i<c.length-2;i++){
    const sl=c.slice(i-5,i);
    if(sl.filter(x=>x.c>x.o).length>=4&&c[i].c<c[i].o&&c[i+1].c<c[i+1].o)
      A.mit.push({ty:'bear',hi:c[i].h,lo:Math.min(c[i].l,c[i+1].l),ix:i});
    if(sl.filter(x=>x.c<x.o).length>=4&&c[i].c>c[i].o&&c[i+1].c>c[i+1].o)
      A.mit.push({ty:'bull',hi:Math.max(c[i].h,c[i+1].h),lo:c[i].l,ix:i});
  }

  // â”€â”€ BOS â”€â”€
  const h20=Math.max(...c.slice(-20).map(x=>x.h)),l20=Math.min(...c.slice(-20).map(x=>x.l));
  if(px>h20)A.bos={ty:'bull',lv:h20};else if(px<l20)A.bos={ty:'bear',lv:l20};

  // â”€â”€ CHoCH â”€â”€
  if(sw.H.length>=3&&sw.L.length>=3){
    const all=[];
    sw.H.forEach(h=>all.push({k:'h',p:h.p,i:h.i}));sw.L.forEach(l=>all.push({k:'l',p:l.p,i:l.i}));
    all.sort((a,b)=>a.i-b.i);
    let pDir=null;
    for(let i=1;i<all.length;i++){
      if(all[i].k==='h'){
        const prev=all.slice(0,i).filter(x=>x.k==='h').pop();
        if(prev){const d=all[i].p>prev.p?'bull':'bear';if(pDir&&d!==pDir){A.choch={ty:d,lv:all[i].p};break}pDir=d}
      }
    }
  }

  // â”€â”€ Sweeps â”€â”€
  for(let i=Math.max(0,c.length-8);i<c.length;i++){
    const lb=c.slice(Math.max(0,i-20),i);if(lb.length<5)continue;
    const pH=Math.max(...lb.map(x=>x.h)),pL=Math.min(...lb.map(x=>x.l));
    if(c[i].h>pH*1.001&&c[i].c<pH)A.sweeps.push({ty:'bsl',lv:pH,wk:c[i].h,cl:c[i].c,ix:i});
    if(c[i].l<pL*0.999&&c[i].c>pL)A.sweeps.push({ty:'ssl',lv:pL,wk:c[i].l,cl:c[i].c,ix:i});
  }

  // â”€â”€ Equal H/L â”€â”€
  const tol=px*0.001;
  for(let i=0;i<sw.H.length;i++)for(let j=i+1;j<sw.H.length;j++)
    if(Math.abs(sw.H[i].p-sw.H[j].p)<tol)A.eqHL.push({ty:'eqh',lv:(sw.H[i].p+sw.H[j].p)/2});
  for(let i=0;i<sw.L.length;i++)for(let j=i+1;j<sw.L.length;j++)
    if(Math.abs(sw.L[i].p-sw.L[j].p)<tol)A.eqHL.push({ty:'eql',lv:(sw.L[i].p+sw.L[j].p)/2});

  // â”€â”€ Displacement â”€â”€
  const a10=c.slice(-14,-4).reduce((s,x)=>s+Math.abs(x.c-x.o),0)/10||1;
  let dC=0,dD=0;
  for(let i=c.length-4;i<c.length;i++){if(Math.abs(c[i].c-c[i].o)>a10*2){dC++;dD+=c[i].c>c[i].o?1:-1}}
  if(dC>=2)A.disp={d:dD>0?'bull':'bear',n:dC};

  // â”€â”€ Premium/Discount â”€â”€
  if(sw.H.length&&sw.L.length){
    const rH=Math.max(...sw.H.slice(-4).map(h=>h.p)),rL=Math.min(...sw.L.slice(-4).map(l=>l.p));
    if(rH>rL){const eq=(rH+rL)/2;A.pd={hi:rH,lo:rL,eq,zone:px>eq?'premium':'discount',pct:((px-rL)/(rH-rL)*100).toFixed(0)}}
  }

  // â”€â”€ OTE â”€â”€
  if(sw.H.length&&sw.L.length){
    const sH=sw.H[sw.H.length-1].p,sL=sw.L[sw.L.length-1].p,rng=Math.abs(sH-sL);
    if(rng>0){
      if(sw.H[sw.H.length-1].i>sw.L[sw.L.length-1].i)A.ote={top:sL+rng*0.618,bot:sL+rng*0.5,gld:sL+rng*0.618,sH,sL};
      else A.ote={top:sH-rng*0.5,bot:sH-rng*0.618,gld:sH-rng*0.618,sH,sL};
    }
  }

  // â”€â”€ NDOG â”€â”€
  if($.prevDayClose&&c.length>1){
    const gap=c[0].o-$.prevDayClose;
    if(Math.abs(gap)/px>0.0005)A.ndog={pc:$.prevDayClose,to:c[0].o,gap,filled:(gap>0?px<=$.prevDayClose:px>=$.prevDayClose)};
  }

  // â”€â”€ MMBM/MMSM â”€â”€
  if(A.sweeps.length&&A.disp){
    const ls=A.sweeps[A.sweeps.length-1];
    if(ls.ty==='ssl'&&A.disp.d==='bull')
      A.mmbm={sw:ls.lv,wk:ls.wk,tgt:A.eqHL.filter(e=>e.ty==='eqh').pop()?.lv||A.pd?.hi||px*1.005};
    if(ls.ty==='bsl'&&A.disp.d==='bear')
      A.mmsm={sw:ls.lv,wk:ls.wk,tgt:A.eqHL.filter(e=>e.ty==='eql').pop()?.lv||A.pd?.lo||px*0.995};
  }

  // â”€â”€ DETECTIONS â”€â”€
  const d=A.dets;
  A.fvgs.slice(-3).forEach(f=>d.push({t:"FVG",d:(f.ty==='bull'?'Bull':'Bear')+' '+Pc(f.bot)+'â€“'+Pc(f.top)+' CE:'+Pc(f.mid),p:"high",i:"ğŸ“Š"}));
  A.obs.slice(-2).forEach(o=>d.push({t:"OB",d:(o.ty==='bull'?'Bull':'Bear')+' '+Pc(o.lo)+'â€“'+Pc(o.hi)+' ('+o.st+'x)',p:"high",i:"ğŸ§±"}));
  if(A.bos)d.push({t:"BOS",d:(A.bos.ty==='bull'?'Bull':'Bear')+' broke '+Pc(A.bos.lv),p:"medium",i:"ğŸ“ˆ"});
  if(A.choch)d.push({t:"CHoCH",d:(A.choch.ty==='bull'?'Bull':'Bear')+' reversal '+Pc(A.choch.lv),p:"critical",i:"ğŸ”„"});
  A.sweeps.forEach(s=>d.push({t:"Sweep",d:(s.ty==='bsl'?'BSL':'SSL')+' at '+Pc(s.lv)+' wk:'+Pc(s.wk),p:"critical",i:"ğŸ’§"}));
  A.brk.filter(b=>b.touch).forEach(b=>d.push({t:"Breaker",d:(b.ty==='bull'?'Bull':'Bear')+' '+Pc(b.lo)+'â€“'+Pc(b.hi)+' TOUCH',p:"critical",i:"ğŸ”"}));
  A.brk.filter(b=>!b.touch).slice(-1).forEach(b=>d.push({t:"Breaker",d:(b.ty==='bull'?'Bull':'Bear')+' '+Pc(b.lo)+'â€“'+Pc(b.hi),p:"high",i:"ğŸ”"}));
  A.mit.slice(-1).forEach(m=>d.push({t:"Mitigation",d:(m.ty==='bull'?'Bull':'Bear')+' '+Pc(m.lo)+'â€“'+Pc(m.hi),p:"medium",i:"ğŸ”ƒ"}));
  A.eqHL.slice(-2).forEach(e=>d.push({t:e.ty==='eqh'?"EQH":"EQL",d:(e.ty==='eqh'?'BSL':'SSL')+' pool '+Pc(e.lv),p:"medium",i:"âš–ï¸"}));
  if(A.disp)d.push({t:"Displacement",d:(A.disp.d==='bull'?'Bull':'Bear')+' '+A.disp.n+'x',p:"high",i:"âš¡"});
  if(A.pd)d.push({t:"P/D Zone",d:A.pd.zone.toUpperCase()+' ('+A.pd.pct+'%) EQ:'+Pc(A.pd.eq),p:"medium",i:"ğŸ’°"});
  if(A.ote){const io=px>=Math.min(A.ote.bot,A.ote.top)&&px<=Math.max(A.ote.bot,A.ote.top);
    d.push({t:"OTE",d:Pc(A.ote.bot)+'â€“'+Pc(A.ote.top)+(io?' â† IN OTE':''),p:io?"critical":"medium",i:"ğŸ¯"})}
  if(A.mmbm)d.push({t:"MMBM",d:'SSLâ†’'+Pc(A.mmbm.sw)+' tgt:'+Pc(A.mmbm.tgt),p:"critical",i:"ğŸ“ˆ"});
  if(A.mmsm)d.push({t:"MMSM",d:'BSLâ†’'+Pc(A.mmsm.sw)+' tgt:'+Pc(A.mmsm.tgt),p:"critical",i:"ğŸ“‰"});
  if(A.ndog)d.push({t:"NDOG",d:Pc(A.ndog.pc)+'â†’'+Pc(A.ndog.to)+(A.ndog.filled?' filled':' open'),p:"medium",i:"ğŸ“…"});
  if(A.sess.kz)d.push({t:"Kill Zone",d:A.sess.n+(A.sess.sb?' SB':''),p:"critical",i:"ğŸ•"});

  // â”€â”€ Confidence â”€â”€
  let cf=35;
  if(A.bias!=='Neutral')cf+=10;if(A.fvgs.length)cf+=8;if(A.obs.length)cf+=8;if(A.sweeps.length)cf+=15;if(A.disp)cf+=10;if(A.sess.kz)cf+=8;if(A.choch)cf+=5;if(A.brk.some(b=>b.touch))cf+=8;if(A.mmbm||A.mmsm)cf+=10;
  if(A.ote){if(px>=Math.min(A.ote.bot,A.ote.top)&&px<=Math.max(A.ote.bot,A.ote.top))cf+=12}
  A.conf=Math.min(cf,98);

  // â”€â”€ Trade â”€â”€
  const hasSw=A.sweeps.length>0,hasDp=!!A.disp,hasPOI=A.fvgs.length>0||A.obs.length>0||A.brk.some(b=>b.touch);
  const inOTE=A.ote&&px>=Math.min(A.ote.bot,A.ote.top)&&px<=Math.max(A.ote.bot,A.ote.top);
  if(A.bias!=='Neutral'&&hasPOI&&(hasSw||hasDp)&&(inOTE||A.sess.kz||A.conf>=75)){
    const dir=A.bias==='Bullish'?'LONG':'SHORT';
    let ent=px;
    if(A.fvgs.length)ent=A.fvgs[A.fvgs.length-1].mid;
    else if(A.obs.length)ent=A.obs[A.obs.length-1].mid;
    else if(A.brk.length)ent=A.brk[A.brk.length-1].mid;
    const swWk=A.sweeps.length?A.sweeps[A.sweeps.length-1].wk:null;
    let sl;
    if(dir==='LONG')sl=swWk&&swWk<ent?swWk-Math.abs(ent-swWk)*0.1:ent*(1-0.004);
    else sl=swWk&&swWk>ent?swWk+Math.abs(swWk-ent)*0.1:ent*(1+0.004);
    const slD=Math.abs(ent-sl);
    const tp=A.eqHL.length?A.eqHL[A.eqHL.length-1].lv:(dir==='LONG'?ent+slD*3.5:ent-slD*3.5);
    let mdl="2022 ICT";if(A.mmbm)mdl="MMBM";else if(A.mmsm)mdl="MMSM";else if(A.sess.sb)mdl="Silver Bullet";else if(hasSw&&hasDp)mdl="Liq Sweep";else if(A.brk.some(b=>b.touch))mdl="Breaker";else if(inOTE)mdl="OTE";
    const eR=[];
    if(A.fvgs.length){const f=A.fvgs[A.fvgs.length-1];eR.push((f.ty==='bull'?'Bull':'Bear')+' FVG '+Pc(f.bot)+'-'+Pc(f.top))}
    if(A.obs.length){const o=A.obs[A.obs.length-1];eR.push((o.ty==='bull'?'Bull':'Bear')+' OB '+Pc(o.lo)+'-'+Pc(o.hi))}
    if(A.brk.some(b=>b.touch))eR.push('Breaker confluence');
    A.trade={dir,ent:P(ent),sl:P(sl),tp1:P(dir==='LONG'?ent+slD*2:ent-slD*2),tp2:P(tp),rr:'1:'+(Math.abs(tp-ent)/slD).toFixed(1),mdl,eR:eR.join(' + '),slR:swWk?'Beyond sweep '+Pc(swWk):'Beyond OB'};
  }
  return A;
}

// â•â•â• FIBONACCI â•â•â•
function calcFib(){
  const c=$.candles;if(c.length<10)return null;
  const r=c.slice(-30),sH=Math.max(...r.map(x=>x.h)),sL=Math.min(...r.map(x=>x.l)),rng=sH-sL;
  if(rng<=0)return null;
  const px=nowPrice();
  const lvs=[0,0.236,0.382,0.5,0.618,0.705,0.786,1].map(r=>({r,px:sH-rng*r,lb:r===0?'0(Hi)':r===1?'1(Lo)':String(r)}));
  return{sH,sL,rng,lvs,px,pct:((sH-px)/rng*100).toFixed(1),inOTE:px<=(sH-rng*0.5)&&px>=(sH-rng*0.618)};
}
function showFib(){
  const fp=document.getElementById('fib-panel');$.fib=calcFib();
  if(!$.fib){fp.style.display='none';return}fp.style.display='block';const f=$.fib;
  fp.innerHTML=`<div style="padding:4px 8px;background:var(--bg3);border-top:1px solid var(--border)"><div style="font-size:7px;font-weight:700;color:#b8a9ff;margin-bottom:2px">ğŸ“ FIB: ${Pc(f.sH)}â†’${Pc(f.sL)} | ${f.pct}% ${f.inOTE?'<span style="color:var(--green)">OTE</span>':''}</div><div class="fib-bar">${f.lvs.map(l=>{const ot=l.r>=0.5&&l.r<=0.618,nr=Math.abs(f.px-l.px)/f.rng<0.025;return`<div class="fib-lv" style="background:${nr?'rgba(108,92,231,.15)':ot?'rgba(0,212,170,.06)':'rgba(0,0,0,.15)'};border:1px solid ${nr?'var(--accent)':ot?'rgba(0,212,170,.15)':'transparent'}"><div class="fl">${l.lb}${ot?' â˜…':''}</div><div class="fv" style="color:${nr?'var(--accent)':'var(--text1)'}">${Pc(l.px)}</div></div>`}).join('')}</div></div>`;
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 100+ ICT/SMC KNOWLEDGE BASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const KB={
"FVG":"Fair Value Gap â€” 3-candle imbalance: candle1.high < candle3.low (bullish) or candle1.low > candle3.high (bearish). Price returns to fill the gap. Entry at CE (Consequent Encroachment = 50% of gap).","IFVG":"Inverted FVG â€” A filled FVG that now acts as S/R in the opposite direction. Bullish IFVG becomes resistance, bearish IFVG becomes support.","Implied FVG":"A gap that doesn't show on current TF but exists on lower TF. Often found inside displacement candles.","Micro FVG":"Tiny FVG on 1m/5m chart. Used for precision entries after HTF bias is confirmed.","FVG Continuation":"When price fills FVG partially and then continues in the original direction. The partial fill IS the entry.",
"OB":"Order Block â€” Last opposing candle before displacement. Bullish OB = last bearish candle before bullish run. Bearish OB = last bullish candle before bearish run.","Extreme OB":"The very first OB in a move. Highest probability because it's where the initial institutional order was placed.","High Prob OB":"OB that has FVG + displacement + is in OTE zone. Multiple confluence = high probability.","Low Prob OB":"OB without confluence. May hold but less reliable. Use for partial entries only.",
"Breaker Block":"Failed OB that price traded through. Now acts as inverted S/R. Bullish OB that fails becomes bearish breaker (resistance). Very high probability zone.","Mitigation Block":"Zone where institutions return to close losing positions. Similar to breaker but specifically where trapped orders get mitigated.",
"BOS":"Break of Structure â€” Price breaks a swing high (bullish BOS) or swing low (bearish BOS), confirming trend continuation.","CHoCH":"Change of Character â€” First break of structure in the OPPOSITE direction. Signals potential reversal. More significant than BOS.","MSS":"Market Structure Shift â€” Same as CHoCH. The moment market tips from bullish to bearish or vice versa. Key trigger for entries.","MSB":"Market Structure Break â€” Alternative term for BOS/CHoCH. Used when structure is definitively broken.",
"BSL":"Buy Side Liquidity â€” Resting stop losses and buy stops above swing highs. Institutions target these pools.","SSL":"Sell Side Liquidity â€” Resting stop losses and sell stops below swing lows. Institutions target these pools.","Internal Liq":"Liquidity resting inside a range â€” at FVGs, OBs, and minor swing points. Targeted before external liq.","External Liq":"Liquidity at major swing highs/lows (the range boundaries). The ultimate targets for institutional moves.","Liq Void":"Area with no trading activity (no candle bodies). Price moves through quickly. Similar to FVG but larger.","Liq Pool":"Cluster of equal highs or lows. Multiple stop losses at same level = bigger pool = higher probability target.","Liq Grab":"Quick spike through a key level to trigger stops, then immediate reversal. Classic institutional move.",
"EQH":"Equal Highs â€” Two or more swing highs at the same price. Creates BSL pool. Institutions will sweep these.","EQL":"Equal Lows â€” Two or more swing lows at the same price. Creates SSL pool. Institutions will sweep these.",
"Displacement":"3+ strong same-direction candles with bodies > 2x average. Shows institutional commitment and creates FVGs.","Inducement":"False move designed to trap retail traders. Price moves to an obvious S/R level to trigger entries, then reverses. ICT calls this 'engineered liquidity'.","Stop Hunt":"Deliberate push past a key level to trigger clustered stop losses, then reversal. Foundation of ICT methodology.",
"OTE":"Optimal Trade Entry â€” 50-61.8% Fibonacci retracement zone. This is where institutions re-enter after displacement. Golden ratio at 0.618.","Golden OTE":"The 0.618 Fibonacci level specifically. Highest probability single entry point within the OTE zone.",
"KZ":"Kill Zone â€” London 3-5AM EST, NY 10AM-12PM EST. Peak institutional trading windows. Highest probability setups form here.","Silver Bullet":"Specific 1-hour windows: 3-4AM, 10-11AM, 1-2PM EST. Look for FVG to form during these windows and enter on return to CE.","Asian Range":"The high-low range formed during Asian session (8PM-3AM EST). London/NY sessions will sweep one side.","Asian Trifecta":"Asian range establishes high/low â†’ London sweeps one side â†’ NY targets opposite side.","London Trifecta":"1) Asian range forms 2) London sweeps Asian low 3) Rally to Asian high and beyond.","NY Trifecta":"1) London establishes high 2) NY sweeps London high 3) Reversal targeting sell-side.",
"PD":"Premium/Discount â€” Above 50% of range = premium (look for shorts). Below 50% = discount (look for longs).","PD Array":"PD Array Matrix â€” All price levels that act as S/R: FVGs, OBs, Breakers, Mitigation, EQH/EQL. Ranked by probability.",
"MMBM":"Market Maker Buy Model â€” 4 phases: 1) Accumulation (range) 2) Manipulation (sweep SSL) 3) Expansion (bullish displacement) 4) Distribution (target BSL). The full institutional buying cycle.","MMSM":"Market Maker Sell Model â€” 4 phases: 1) Distribution (range) 2) Manipulation (sweep BSL) 3) Expansion (bearish displacement) 4) Accumulation (target SSL). The full institutional selling cycle.","MMXM":"Market Maker Exchange Model â€” Generic term for both MMBM and MMSM. The complete manipulationâ†’expansion cycle.",
"PO3":"Power of Three â€” Every candle has 3 phases: Accumulation (open), Manipulation (wick), Distribution/Expansion (close). Applies to all timeframes.","DOL":"Draw on Liquidity â€” The magnet price is heading toward. Usually equal highs/lows, untouched OBs, or unfilled FVGs.","CE":"Consequent Encroachment â€” The 50% level of any FVG, wick, or range. Key entry point.","Mean Threshold":"The 50% level of an OB. Price often reacts at this exact level. Optimal entry within an OB.",
"NDOG":"New Day Opening Gap â€” Gap between previous day's close and current day's open. Acts as magnet â€” price tends to fill.","VI":"Volume Imbalance â€” Gap between one candle's close and the next candle's open. Similar to FVG but only 2 candles. Fast fill expected.","BPR":"Balanced Price Range â€” Where a bullish FVG and bearish FVG overlap. Creates a balanced zone. Price tends to consolidate here.",
"HTF":"Higher Time Frame â€” 4H, Daily, Weekly. Used for bias determination. HTF bias > LTF bias always.","LTF":"Lower Time Frame â€” 1m, 5m, 15m. Used for precision entries after HTF bias is confirmed.","MTF":"Multi-Timeframe Analysis â€” HTF determines bias â†’ LTF finds entry. The core ICT approach. Always top-down.",
"SMT":"Smart Money Technique / SMT Divergence â€” When correlated pairs (e.g. ES vs NQ) make different structures. One sweeps liquidity while the other doesn't. Signals institutional divergence.","COT":"Commitment of Traders â€” Weekly report showing institutional positioning. Confirms HTF bias.","IOF":"Institutional Order Flow â€” The direction institutions are trading, determined by structure, sweeps, and displacement.",
"HH":"Higher High â€” Swing high above previous swing high. Bullish structure.","HL":"Higher Low â€” Swing low above previous swing low. Bullish structure.","LH":"Lower High â€” Swing high below previous swing high. Bearish structure.","LL":"Lower Low â€” Swing low below previous swing low. Bearish structure.",
"Swing High":"A high with lower highs on both sides. Key structural point. Lookback of 3-5 candles.","Swing Low":"A low with higher lows on both sides. Key structural point.","Supply Zone":"Area where selling pressure overwhelms buying. Bearish OBs and bearish breakers form supply.","Demand Zone":"Area where buying pressure overwhelms selling. Bullish OBs and bullish breakers form demand.",
"Wyckoff":"Wyckoff methodology integrated with ICT: Accumulation=MMBM phase 1, Markup=expansion, Distribution=MMSM phase 1, Markdown=bear expansion. ICT is modern Wyckoff.","Turtle Soup":"ICT term for false breakout. Price breaks a key level (stop hunt), immediately reverses. Named after the failed 'Turtle' trend-following signals.","Quasimodo":"QML pattern: HHâ†’HLâ†’LH with the LH failing to reach the HH. Creates a specific reversal pattern at the neckline.","RBD":"Rally-Base-Drop. Bullish move, consolidation, then bearish break. The base becomes future resistance. ICT equivalent: bearish OB.","DBR":"Drop-Base-Rally. Bearish move, consolidation, then bullish break. The base becomes future support. ICT equivalent: bullish OB.",
"CISD":"Change in State of Delivery â€” When price changes from bullish delivery to bearish delivery or vice versa. Seen as body candle closes through a key level.","Anchoring":"Using a specific price point (session open, previous close, VWAP) as a reference for bias. If price > anchor = bullish, if price < anchor = bearish.","Fresh Zone":"An OB or FVG that hasn't been touched/tested yet. Fresh zones have highest probability. Once tested, probability drops.","Nested PD":"PD Array inside another PD array on a higher timeframe. Creates extremely high probability zones.","Time+Price":"ICT principle: the RIGHT price at the RIGHT time. A perfect FVG entry means nothing outside a Kill Zone. Both must align.","VWAP+SMC":"VWAP as dynamic EQ level. Price above VWAP = premium, below = discount. Use with ICT PD arrays for confluence.","Trendline Liq":"Liquidity resting along trendlines. Institutions know retail places stops behind trendlines. These get swept.","Weekly/Monthly":"Weekly and monthly opens/closes act as major DOL. Institutions target these levels for large moves."
};

const TRACKS={
"Classic OTE":"Sweepâ†’Displacement(MSS)â†’OTE zone(0.618)â†’Entryâ†’Target opposing liquidity",
"FVG Momentum":"Sweepâ†’MSSâ†’First FVG formsâ†’Entry at FVG CEâ†’Target next liq pool",
"Breaker Retest":"BOSâ†’Return to breaker blockâ†’Entry at retestâ†’SL beyond blockâ†’Target swing projection",
"Turtle Soup":"Asian range sweepâ†’Close back inside(MSS)â†’Entry at 50% sweep candleâ†’Target opposite side",
"Silver Bullet":"KZ windowâ†’Opening range sweepâ†’Displacementâ†’Entry at FVG/OTEâ†’Target 2R minimum",
"OB Mitigation":"Price returns to OBâ†’Wick rejects(mitigation)â†’Entry at OB bodyâ†’SL beyond wickâ†’Target HTF draw",
"BPR Play":"Consolidation forms BPRâ†’Sweep rangeâ†’Close back inside(MSS)â†’Entry at BPR midâ†’Target opposite boundary",
"SMT Divergence":"Correlated pair sweepsâ†’Main pair fails to sweep(SMT)â†’Displacementâ†’Entry at FVGâ†’Target liquidity",
"1H Alignment":"4H direction setâ†’1H pullbackâ†’5M MSS in 4H directionâ†’Entry at 5M FVGâ†’Target 4H liq",
"KZ Fade":"NY open sweepâ†’Immediate rejectionâ†’5M MSS oppositeâ†’Entry at first FVGâ†’Target pre-open liq",
"OTE+FVG":"Sweepâ†’Displacementâ†’OTE reachedâ†’FVG forms inside OTEâ†’Entry at FVG/OTE confluenceâ†’Target HTF DOL"
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI WATCHER â€” ALWAYS uses nowPrice() for live accuracy
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startWatch(){
  if($.wI)clearInterval($.wI);
  document.getElementById('aw-feed').innerHTML='';
  awM('s',`ğŸ‘ <strong>AI Watcher</strong> on <span class="a">${$.sym.sh}</span> (${TFS.find(t=>t.v===$.tf)?.l})`);
  startFeed();$.wCyc=0;
  $.wI=setInterval(()=>{
    $.wCyc++;if($.candles.length<20)return;
    // NUCLEAR FIX: always fresh analysis from current candles
    $.ict=ictAnalyze();$.fib=calcFib();showFib();updPx();
    narrate();
  },12000);
}

function narrate(){
  const A=$.ict;if(!A)return;
  // NUCLEAR: read price LIVE right now, not from analysis
  const px=nowPrice();
  const pool=[];

  pool.push(`ğŸ“ <strong>${A.bias}</strong> â€” ${A.str}. Price: <span class="a">${Pc(px)}</span> ${A.pd?'<span class="'+(A.pd.zone==='discount'?'g':'r')+'">'+A.pd.zone.toUpperCase()+'</span> ('+A.pd.pct+'%)':''}`);

  if(A.fvgs.length){const f=A.fvgs[A.fvgs.length-1];const inside=px>=f.bot&&px<=f.top;const near=Math.abs(px-f.mid)/px<0.002;
    pool.push(`ğŸ“Š <strong>FVG:</strong> ${f.ty==='bull'?'Bull':'Bear'} <span class="a">${Pc(f.bot)}â€“${Pc(f.top)}</span> CE:${Pc(f.mid)} ${inside?'<span class="g">INSIDE â€” filling!</span>':near?'<span class="g">Near fill!</span>':''}`)}

  if(A.obs.length){const o=A.obs[A.obs.length-1];const tap=px>=o.lo&&px<=o.hi;
    if(tap)pool.push(`ğŸ§± <strong>OB TAP!</strong> ${Pc(px)} inside ${o.ty} OB <span class="a">${Pc(o.lo)}â€“${Pc(o.hi)}</span> â€” <span class="${o.ty==='bull'?'g':'r'}">Reaction zone!</span>`);
    else pool.push(`ğŸ§± <strong>OB:</strong> ${o.ty} at <span class="a">${Pc(o.lo)}â€“${Pc(o.hi)}</span> (${o.st}x disp)`)}

  if(A.sweeps.length){const s=A.sweeps[A.sweeps.length-1];
    pool.push(`ğŸ’§ <strong>Sweep:</strong> ${s.ty==='bsl'?'<span class="r">BSL</span>':'<span class="g">SSL</span>'} at ${Pc(s.lv)}, wk ${Pc(s.wk)}, closed ${Pc(s.cl)} â€” stops taken.`)}

  if(A.disp)pool.push(`âš¡ <strong>Displacement:</strong> ${A.disp.d==='bull'?'<span class="g">Bullish</span>':'<span class="r">Bearish</span>'} ${A.disp.n}x impulsive.`);

  if(A.mmbm)pool.push(`ğŸ“ˆ <strong>MMBM:</strong> SSL swept <span class="g">${Pc(A.mmbm.sw)}</span> â†’ Bull expansion â†’ Target BSL <span class="a">${Pc(A.mmbm.tgt)}</span>`);
  if(A.mmsm)pool.push(`ğŸ“‰ <strong>MMSM:</strong> BSL swept <span class="r">${Pc(A.mmsm.sw)}</span> â†’ Bear expansion â†’ Target SSL <span class="a">${Pc(A.mmsm.tgt)}</span>`);

  A.brk.filter(b=>b.touch).forEach(b=>pool.push(`ğŸ” <strong>Breaker TAP!</strong> ${b.ty} breaker <span class="a">${Pc(b.lo)}â€“${Pc(b.hi)}</span> â€” high prob reaction!`));

  if(A.choch)pool.push(`ğŸ”„ <strong>CHoCH:</strong> ${A.choch.ty} reversal at ${Pc(A.choch.lv)} â€” structure shift!`);

  if(A.sess.sb){const sbF=A.fvgs.filter(f=>$.candles.length-f.ix<=4).pop();
    pool.push(`ğŸ”« <strong>Silver Bullet:</strong> ${A.sess.n} ${sbF?'FVG at '+Pc(sbF.bot)+'â€“'+Pc(sbF.top)+' â€” <span class="g">SB entry!</span>':'Watching for FVG...'}`)}

  if(A.ndog)pool.push(`ğŸ“… <strong>NDOG:</strong> ${Pc(A.ndog.pc)}â†’${Pc(A.ndog.to)} ${A.ndog.filled?'<span class="g">Filled</span>':'<span class="y">Open</span>'}`);

  if(A.eqHL.length){const e=A.eqHL[A.eqHL.length-1];const nr=Math.abs(px-e.lv)/px<0.002;
    pool.push(`âš–ï¸ <strong>${e.ty==='eqh'?'EQH(BSL)':'EQL(SSL)'}:</strong> <span class="y">${Pc(e.lv)}</span>${nr?' <span class="r">APPROACHING!</span>':''}`)}

  pool.push(`ğŸ• <strong>${A.sess.n}</strong> ${A.sess.p} ${A.sess.kz?'<span class="g">KZ</span>':''}${A.sess.sb?'<span class="a">SB</span>':''}`);

  // Priority sort: actionable first
  const pri=pool.filter(m=>m.includes('TAP')||m.includes('MMBM')||m.includes('MMSM')||m.includes('SB entry')||m.includes('CHoCH')||m.includes('APPROACH'));
  const rest=pool.filter(m=>!pri.includes(m)).sort(()=>Math.random()-.5);
  [...pri.slice(0,2),...rest].slice(0,3).forEach((m,i)=>setTimeout(()=>awM('o',m),i*1100));

  // â•â•â• ACTIONABLE ENTRY SIGNALS â•â•â•
  if(A.trade&&A.conf>=68){
    const t=A.trade;
    const obTap=A.obs.length&&px>=A.obs[A.obs.length-1].lo&&px<=A.obs[A.obs.length-1].hi;
    const fvgNr=A.fvgs.length&&Math.abs(px-A.fvgs[A.fvgs.length-1].mid)/px<0.002;
    const brkT=A.brk.some(b=>b.touch);
    if(obTap||fvgNr||brkT||(A.sess.kz&&A.conf>=75)||$.wCyc%4===0){
      let why='';
      if(obTap){const o=A.obs[A.obs.length-1];why='Price tapped '+o.ty+' OB '+Pc(o.lo)+'-'+Pc(o.hi)}
      if(fvgNr){const f=A.fvgs[A.fvgs.length-1];why+=(why?' + ':'')+f.ty+' FVG '+Pc(f.bot)+'-'+Pc(f.top)}
      if(brkT)why+=(why?' + ':'')+'Breaker confluence';
      if(A.mmbm)why+=(why?' + ':'')+'MMBM';if(A.mmsm)why+=(why?' + ':'')+'MMSM';
      if(!why)why=t.eR;
      setTimeout(()=>awA(t.dir==='LONG'?'buy':'sell',
        `<strong>ğŸ¯ ${t.dir} ${$.sym.sh}</strong> @ <span class="a">${Pc(px)}</span><br>`+
        `<span style="font-size:7px;color:var(--text2)">${why}</span><br>`+
        `Entry: <span class="a">${t.ent}</span> | SL: <span class="r">${t.sl}</span> (${t.slR}) | TP1: <span class="g">${t.tp1}</span> | TP2: <span class="b">${t.tp2}</span><br>`+
        `R:R: ${t.rr} | ${t.mdl} | ${A.conf}%`
      ),3500);
    }
  }
}

function awM(ty,html){const t=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});const ic={s:'ğŸ¤–',i:'â„¹ï¸',o:'ğŸ‘'}[ty]||'ğŸ‘';const f=document.getElementById('aw-feed');const d=document.createElement('div');d.className='aw-msg';d.innerHTML=`<div class="aw-ts">${t}</div><div class="aw-ico">${ic}</div><div class="aw-txt">${html}</div>`;f.appendChild(d);f.scrollTop=f.scrollHeight;while(f.children.length>80)f.removeChild(f.firstChild)}
function awA(ty,html){const t=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});const f=document.getElementById('aw-feed');const d=document.createElement('div');d.className='aw-alert '+ty;d.innerHTML=`<div class="aw-ts">${t}</div><div class="aw-txt">${html}</div>`;f.appendChild(d);f.scrollTop=f.scrollHeight;while(f.children.length>80)f.removeChild(f.firstChild)}

// â•â•â• WATCHER CHAT â•â•â•
function askW(){
  const inp=document.getElementById('aw-inp');const msg=inp.value.trim();if(!msg)return;inp.value='';
  awM('i','<span class="b">You:</span> '+msg);
  if($.candles.length>=20){$.ict=ictAnalyze();$.fib=calcFib()}
  setTimeout(()=>awM('o',ansQ(msg)),300);
}
function ansQ(msg){
  const m=msg.toLowerCase(),A=$.ict,fi=$.fib,px=nowPrice();
  if(!A)return'âš ï¸ No data yet.';
  if(m.includes('fib')||m.includes('ote')){showFib();return fi?`ğŸ“ Fib ${Pc(fi.sH)}â†’${Pc(fi.sL)} | ${fi.pct}%${fi.inOTE?' <span class="g">IN OTE</span>':''} | .5=${Pc(fi.lvs[3].px)} .618=${Pc(fi.lvs[4].px)}`:'No fib.'}
  if(m.includes('bias')||m.includes('trend'))return`<strong>${A.bias}</strong> ${A.conf}% â€” ${A.str} ${A.mmbm?'MMBM':''}${A.mmsm?'MMSM':''}`;
  if(m.includes('fvg'))return A.fvgs.length?'ğŸ“Š '+A.fvgs.slice(-4).map(f=>(f.ty==='bull'?'ğŸŸ¢':'ğŸ”´')+' '+Pc(f.bot)+'-'+Pc(f.top)+' CE:'+Pc(f.mid)).join(' | '):'No FVGs.';
  if(m.match(/\bob\b/)||m.includes('order block'))return A.obs.length?'ğŸ§± '+A.obs.slice(-3).map(o=>(o.ty==='bull'?'ğŸŸ¢':'ğŸ”´')+' '+Pc(o.lo)+'-'+Pc(o.hi)).join(' | '):'No OBs.';
  if(m.includes('breaker'))return A.brk.length?'ğŸ” '+A.brk.slice(-2).map(b=>Pc(b.lo)+'-'+Pc(b.hi)+(b.touch?' TOUCH':'')).join(' | '):'No breakers.';
  if(m.includes('sweep')||m.includes('liquid'))return A.sweeps.length?'ğŸ’§ '+A.sweeps.map(s=>s.ty+' at '+Pc(s.lv)+' wk:'+Pc(s.wk)).join(' | '):'No sweeps.';
  if(m.includes('enter')||m.includes('trade')||m.includes('setup')||m.includes('should')){
    if(!A.trade)return'â³ NO TRADE. '+(A.sweeps.length?'âœ…':'âŒ')+' Sweep '+(A.disp?'âœ…':'âŒ')+' Disp '+(A.fvgs.length?'âœ…':'âŒ')+' FVG '+(fi?.inOTE?'âœ…':'âŒ')+' OTE '+(A.sess.kz?'âœ…':'âš ï¸')+' KZ';
    const t=A.trade;return`<strong>${t.dir} ${$.sym.sh}</strong> ${t.mdl}<br>Entry: <span class="a">${t.ent}</span> (${t.eR}) | SL: <span class="r">${t.sl}</span> | TP: <span class="g">${t.tp1}</span>/<span class="b">${t.tp2}</span> | R:R ${t.rr} | ${A.conf}%`}
  if(m.includes('price'))return`ğŸ’µ ${$.sym.sh}: <strong>${Pc(px)}</strong> ${$.dataLive?'ğŸ“¡':'âš ï¸'} ${A.pd?A.pd.zone+' ('+A.pd.pct+'%)':''}`;
  if(m.includes('session')||m.includes('kz'))return`ğŸ• ${A.sess.n} â€” ${A.sess.p} ${A.sess.kz?'KZ':''} ${A.sess.sb?'SB':''}`;
  return'ğŸ¤– Ask: bias, fib, FVG, OB, breaker, sweep, trade, enter, price, session';
}

// â•â•â• CHART+TOPBAR â•â•â•
function loadChart(){
  const sym=$.sym.s,tf=$.tf;
  // Use TradingView advanced chart widget â€” it sends postMessage with price updates
  document.getElementById('chart-wrap').innerHTML=`<iframe id="tv-chart" src="https://www.tradingview.com/widgetembed/?frameElementId=tv&symbol=${encodeURIComponent(sym)}&interval=${tf}&hidesidetoolbar=0&hidetoptoolbar=0&symboledit=1&saveimage=1&toolbarbg=1e222d&studies=MAExp%40tv-basicstudies%1FVWAP%40tv-basicstudies&theme=dark&style=1&timezone=exchange&locale=en&withdateranges=1" style="width:100%;height:100%;border:none" allowfullscreen></iframe>`;
}
function updPx(){
  const el=document.getElementById('price-disp');const px=nowPrice();
  const age=$.lastFetchMs?Math.round((Date.now()-$.lastFetchMs)/1000):99;
  const fresh=age<15;
  el.innerHTML=`<span style="color:${$.ict?.bias==='Bullish'?'var(--green)':$.ict?.bias==='Bearish'?'var(--red)':'var(--text1)'}">${Pc(px)}</span><span style="font-size:6px;color:${fresh?'var(--green)':age<30?'var(--yellow)':'var(--red)'};margin-left:3px">${$.pxSrc==='ref'?'REF':fresh?'â—':age+'s'}</span>`;
}
function rTF(){document.getElementById('tfbar').innerHTML=TFS.map(t=>`<button class="tf ${$.tf===t.v?'on':''}" onclick="chTF('${t.v}')">${t.l}</button>`).join('')}
function rSess(){const s=getSess();document.getElementById('sessbdg').innerHTML=`${s.i} <span style="color:${s.c}">${s.n}</span>${s.kz?'<span class="kzt">KZ</span>':''}${s.sb?'<span class="kzt" style="background:rgba(108,92,231,.1);color:var(--accent)">SB</span>':''}`}
function rSymL(){const q=document.getElementById('ssinp').value.toLowerCase();document.getElementById('slist').innerHTML=SYMS.filter(s=>s.n.toLowerCase().includes(q)||s.sh.toLowerCase().includes(q)).map(s=>`<div class="si hover-row ${s.s===$.sym.s?'act':''}" onclick="selSym('${s.s}')"><span>${s.n}</span><span style="font-size:8px;color:var(--accent);font-family:'DM Mono',monospace">${s.sh}</span></div>`).join('')}
function toggleSym(){const d=document.getElementById('sdrop');d.classList.toggle('open');if(d.classList.contains('open')){rSymL();document.getElementById('ssinp').focus()}}
function filterSym(){rSymL()}
function selSym(sym){$.sym=SYMS.find(s=>s.s===sym);$.analysis=null;$.candles=[];$.ict=null;$.fib=null;$.tickPrice=null;if($.tickI)clearInterval($.tickI);document.getElementById('symlbl').textContent=$.sym.sh;document.getElementById('sdrop').classList.remove('open');document.getElementById('aw-sym').textContent=$.sym.sh;loadChart();rP();startWatch()}
function chTF(tf){$.tf=tf;$.candles=[];$.ict=null;rTF();loadChart();rP();startFeed();awM('s','ğŸ”„ TF â†’ <span class="a">'+TFS.find(t=>t.v===tf)?.l+'</span>')}
function toggleAuto(){$.auto=!$.auto;const b=document.getElementById('autob'),l=document.getElementById('autolbl');if($.auto){b.classList.add('on');l.textContent='AUTO ON';doAnalyze();$.autoI=setInterval(doAnalyze,45000)}else{b.classList.remove('on');l.textContent='AUTO';if($.autoI)clearInterval($.autoI)}}

function doAnalyze(){
  if($.busy)return;$.busy=true;document.getElementById('abtn').disabled=true;document.getElementById('aov').classList.add('show');
  document.getElementById('scanst').textContent='Fetching...';
  fetchLive().then(ok=>{
    if(ok&&$.candles.length>=20){
      document.getElementById('scanst').textContent='Analyzing...';
      $.ict=ictAnalyze();$.fib=calcFib();$.analysis=$.ict;showFib();
      if($.analysis?.trade&&$.analysis.conf>=70){
        const a=$.analysis,n={id:Date.now(),time:new Date(),sym:$.sym.sh,dir:a.trade.dir,conf:a.conf,mdl:a.trade.mdl,ent:a.trade.ent,sl:a.trade.sl,tp1:a.trade.tp1,tp2:a.trade.tp2,rr:a.trade.rr,read:false};
        $.notifs.unshift(n);if($.notifs.length>30)$.notifs=$.notifs.slice(0,30);updNC();showToast(n);
      }
      awM('o','ğŸ“Š <strong>'+$.analysis.bias+'</strong> '+$.analysis.conf+'% â€” '+$.analysis.dets.length+' dets. '+($.analysis.trade?$.analysis.trade.dir+' @ '+$.analysis.trade.ent:'No trade.'));
    }
    $.busy=false;document.getElementById('abtn').disabled=false;document.getElementById('aov').classList.remove('show');
    $.tab='analysis';rP();
  });
}
function showToast(n){const c=document.getElementById('toasts'),id='t'+n.id,d=document.createElement('div');d.className='toast';d.id=id;d.innerHTML=`<button class="toast-x" onclick="document.getElementById('${id}').remove()">âœ•</button><div style="display:flex;align-items:center;gap:4px;margin-bottom:3px"><span style="font-size:11px">${n.dir==='LONG'?'ğŸŸ¢':'ğŸ”´'}</span><span style="font-size:10px;font-weight:800;color:${n.dir==='LONG'?'var(--green)':'var(--red)'};font-family:'DM Mono'">${n.dir} ${n.sym}</span><span style="font-size:9px;font-weight:700;color:${n.conf>=80?'var(--green)':'var(--yellow)'};font-family:'DM Mono';margin-left:auto">${n.conf}%</span></div><div style="font-size:7px;color:var(--accent);font-weight:600;margin-bottom:2px">âš¡ ${n.mdl}</div><div class="g4">${[{l:'ENTRY',v:n.ent,c:'var(--text1)'},{l:'SL',v:n.sl,c:'var(--red)'},{l:'TP1',v:n.tp1,c:'var(--green)'},{l:'TP2',v:n.tp2,c:'var(--blue)'}].map(x=>`<div style="text-align:center;padding:2px;background:rgba(0,0,0,.2);border-radius:2px"><div style="font-size:5px;color:var(--text3)">${x.l}</div><div style="font-size:8px;font-weight:600;color:${x.c};font-family:'DM Mono'">${x.v}</div></div>`).join('')}</div>`;c.appendChild(d);setTimeout(()=>{const el=document.getElementById(id);if(el)el.remove()},8000)}
function updNC(){const u=$.notifs.filter(n=>!n.read).length;const el=document.getElementById('ncnt');if(u>0){el.style.display='flex';el.textContent=u}else el.style.display='none'}

// â•â•â• PANELS â•â•â•
function rP(){
  const u=$.notifs.filter(n=>!n.read).length;
  document.getElementById('ptabs').innerHTML=[{id:'analysis',l:'ğŸ“Š ANALYSIS',b:$.analysis?1:0},{id:'signals',l:'ğŸ”” SIGNALS',b:u},{id:'chat',l:'ğŸ’¬ CHAT',b:0},{id:'kb',l:'ğŸ“˜ KB',b:0}].map(t=>`<button class="ptab ${$.tab===t.id?'on':''}" onclick="sTab('${t.id}')">${t.l}${t.b?'<span class="tbadge">'+t.b+'</span>':''}</button>`).join('');
  document.getElementById('cinarea').style.display=$.tab==='chat'?'block':'none';
  const b=document.getElementById('pbody');
  if($.tab==='analysis')rAn(b);else if($.tab==='signals')rSig(b);else if($.tab==='chat')rCh(b);else rKB(b);
}
function sTab(t){$.tab=t;rP()}

function rAn(b){
  if(!$.analysis){b.innerHTML=`<div style="text-align:center;padding:24px"><div style="font-size:32px;margin-bottom:6px">ğŸ“Š</div><div style="font-size:11px;font-weight:600;color:var(--text2)">No Analysis</div><div style="font-size:8px;color:var(--text3);margin-top:3px">Click Analyze for live ICT scan</div><button class="abtn" onclick="doAnalyze()" style="margin:10px auto 0;padding:6px 16px;font-size:9px">ğŸ” Analyze</button></div>`;return}
  const a=$.analysis,px=nowPrice();
  b.innerHTML=`<div class="bcard ${a.bias==='Bullish'?'bull':a.bias==='Bearish'?'bear':''}"><div style="display:flex;justify-content:space-between;margin-bottom:5px"><div style="display:flex;align-items:center;gap:5px"><span style="font-size:14px">${a.bias==='Bullish'?'ğŸŸ¢':a.bias==='Bearish'?'ğŸ”´':'âšª'}</span><div><div style="font-size:13px;font-weight:800;color:${a.bias==='Bullish'?'var(--green)':a.bias==='Bearish'?'var(--red)':'var(--text2)'};font-family:'Instrument Sans'">${a.bias.toUpperCase()}</div><div style="font-size:7px;color:var(--text3)">${$.sym.sh} â€¢ ${TFS.find(t=>t.v===$.tf)?.l} â€¢ ${a.sess.n} ${$.dataLive?'ğŸ“¡':'âš ï¸'}</div></div></div><div style="text-align:right"><div style="font-size:18px;font-weight:800;font-family:'DM Mono';color:${a.conf>=80?'var(--green)':a.conf>=65?'var(--yellow)':'var(--text2)'}">${a.conf}%</div><div style="font-size:6px;color:var(--text3)">CONFIDENCE</div></div></div><div style="font-size:8px;color:var(--text2);padding:3px 5px;background:rgba(0,0,0,.1);border-radius:3px">ğŸ“ ${a.str} â€¢ ${Pc(px)}</div></div>`+
  (a.trade?`<div class="tcard"><div style="font-size:8px;font-weight:700;color:#b8a9ff;margin-bottom:6px">âš¡ ${a.trade.mdl}</div><div class="g2"><div class="sc" style="border:1px solid ${a.trade.dir==='LONG'?'rgba(0,212,170,.1)':'rgba(255,71,87,.1)'}"><div class="sl">DIR</div><div class="sv" style="color:${a.trade.dir==='LONG'?'var(--green)':'var(--red)'}">${a.trade.dir}</div></div><div class="sc" style="border:1px solid var(--border)"><div class="sl">R:R</div><div class="sv" style="color:#b8a9ff">${a.trade.rr}</div></div>${[{l:'ENTRY',v:a.trade.ent,c:'var(--text1)'},{l:'SL',v:a.trade.sl,c:'var(--red)'},{l:'TP1',v:a.trade.tp1,c:'var(--green)'},{l:'TP2',v:a.trade.tp2,c:'var(--blue)'}].map(x=>`<div class="sc"><div class="sl">${x.l}</div><div class="sv" style="color:${x.c}">${x.v}</div></div>`).join('')}</div><div style="margin-top:4px;font-size:7px;color:var(--text3);padding:3px 5px;background:rgba(0,0,0,.1);border-radius:3px">ğŸ“ ${a.trade.eR} | ğŸ›¡ ${a.trade.slR}</div></div>`:'<div style="padding:6px;text-align:center;font-size:8px;color:var(--text3);border:1px dashed var(--border);border-radius:5px;margin-bottom:6px">â³ No trade â€” insufficient confluence</div>')+
  `<div style="font-size:8px;font-weight:700;color:var(--text2);margin-bottom:4px">ğŸ” DETECTIONS (${a.dets.length})</div>`+
  a.dets.map((d,i)=>`<div class="dcard ${d.p} fade-up" style="animation-delay:${i*30}ms"><span style="font-size:10px">${d.i}</span><div style="flex:1"><div style="display:flex;justify-content:space-between"><span style="font-weight:700;color:var(--text1)">${d.t}</span><span style="font-size:5px;padding:1px 3px;border-radius:2px;font-weight:800;${d.p==='critical'?'background:rgba(255,71,87,.1);color:var(--red)':d.p==='high'?'background:rgba(108,92,231,.1);color:var(--accent)':'background:rgba(138,135,160,.08);color:var(--text2)'}">${d.p.toUpperCase()}</span></div><div style="color:var(--text2);margin-top:1px">${d.d}</div></div></div>`).join('');
}

function rSig(b){
  if(!$.notifs.length){b.innerHTML='<div style="text-align:center;padding:24px"><div style="font-size:28px">ğŸ””</div><div style="font-size:10px;color:var(--text3)">No signals</div></div>';return}
  b.innerHTML=`<div style="display:flex;justify-content:space-between;margin-bottom:5px"><span style="font-size:9px;font-weight:700;color:#b8a9ff">Signals</span><button onclick="$.notifs.forEach(n=>n.read=true);updNC();rP()" style="padding:2px 5px;border-radius:2px;border:1px solid var(--border);background:transparent;color:var(--accent);font-size:6px;cursor:pointer;font-family:inherit">Read all</button></div>`+$.notifs.map(n=>`<div class="sigcard ${n.read?'read':'unread'} hover-row"><div style="display:flex;justify-content:space-between;margin-bottom:3px"><div style="display:flex;align-items:center;gap:3px"><span style="font-size:10px">${n.dir==='LONG'?'ğŸŸ¢':'ğŸ”´'}</span><span style="font-size:10px;font-weight:800;color:${n.dir==='LONG'?'var(--green)':'var(--red)'};font-family:'DM Mono'">${n.dir} ${n.sym}</span></div><span style="font-size:9px;font-weight:700;color:${n.conf>=80?'var(--green)':'var(--yellow)'};font-family:'DM Mono'">${n.conf}%</span></div><div style="font-size:7px;color:var(--accent);font-weight:600;margin-bottom:2px">âš¡ ${n.mdl}</div><div class="g4">${[{l:'ENTRY',v:n.ent,c:'var(--text1)'},{l:'SL',v:n.sl,c:'var(--red)'},{l:'TP1',v:n.tp1,c:'var(--green)'},{l:'TP2',v:n.tp2,c:'var(--blue)'}].map(x=>`<div style="text-align:center;padding:2px;background:rgba(0,0,0,.15);border-radius:2px"><div style="font-size:5px;color:var(--text3)">${x.l}</div><div style="font-size:8px;font-weight:600;color:${x.c};font-family:'DM Mono'">${x.v}</div></div>`).join('')}</div><div style="font-size:6px;color:var(--text3);margin-top:2px">${n.time.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} â€¢ ${n.rr}</div></div>`).join('');
}

// â•â•â• CHAT â€” intelligent with live data â•â•â•
function fmtC(t){return t.replace(/\*\*(.*?)\*\*/g,'<strong style="color:var(--text1)">$1</strong>').replace(/__(.*?)__/g,'<span style="color:var(--green);font-weight:700">$1</span>').replace(/~~(.*?)~~/g,'<span style="color:var(--red);font-weight:700">$1</span>').replace(/\^\^(.*?)\^\^/g,'<span style="color:var(--accent);font-weight:600">$1</span>').replace(/\n/g,'<br>')}
function rCh(b){
  if(!$.msgs.length){b.innerHTML=`<div style="text-align:center;padding:10px 5px"><div style="font-size:20px;margin-bottom:4px">ğŸ¤–</div><div style="font-size:9px;font-weight:600;color:var(--text2)">ICT/SMC Live AI</div><div style="font-size:7px;color:var(--text3);margin:2px 0 6px">100+ ICT concepts â€¢ Live analysis â€¢ Trade plans</div><div style="display:flex;flex-direction:column;gap:2px">${["Give me a trade plan","Should I enter now?","What's the bias?","Show FVGs","Where are the OBs?","Fib levels?","Explain MMBM","What is PO3?"].map(p=>`<button class="cprom" onclick="sendC('${p}')">${p}</button>`).join('')}</div></div>`;return}
  b.innerHTML=$.msgs.map(m=>`<div class="cmsg"><div style="display:flex;align-items:center;gap:3px;margin-bottom:2px"><span style="font-size:7px">${m.r==='user'?'ğŸ‘¤':'ğŸ¤–'}</span><span style="font-size:6px;font-weight:600;color:${m.r==='user'?'var(--blue)':'var(--accent)'}">${m.r==='user'?'You':'SMC AI'}</span></div><div class="cbub ${m.r==='user'?'usr':'ai'}">${fmtC(m.c)}</div></div>`).join('')+($.typing?'<div style="padding:6px;font-size:8px;color:var(--accent)"><span style="animation:pulse 1s infinite">â³ Analyzing...</span></div>':'');
  b.scrollTop=b.scrollHeight;
}

async function sendC(txt){
  const msg=txt||document.getElementById('cinp').value.trim();if(!msg)return;document.getElementById('cinp').value='';
  $.msgs.push({r:'user',c:msg});$.typing=true;rP();
  const m=msg.toLowerCase();
  const live=m.includes('trade')||m.includes('enter')||m.includes('bias')||m.includes('fvg')||m.includes('ob')||m.includes('fib')||m.includes('sweep')||m.includes('session')||m.includes('price')||m.includes('breaker')||m.includes('mmbm')||m.includes('setup')||m.includes('give me');
  if(live){if($.candles.length<20)await fetchLive();if($.candles.length>=20){$.ict=ictAnalyze();$.fib=calcFib();$.analysis=$.ict;showFib()}}
  const isTrade=m.includes('trade plan')||m.includes('give me')||m.includes('the trade')||m.includes('the setup')||m.includes('what trade');
  const isEntry=m.includes('should i')||m.includes('enter now')||m.includes('can i enter')||m.includes('take the');
  let resp;
  if(isTrade)resp=bldPlan();else if(isEntry)resp=bldEntry();else resp=bldReply(m);
  setTimeout(()=>{$.typing=false;$.msgs.push({r:'ai',c:resp});rP()},isTrade||isEntry?800:300);
}

function bldPlan(){
  const A=$.ict,fi=$.fib,px=nowPrice(),se=getSess();
  if(!A)return'âš ï¸ No data.';
  let p='**â•â•â• TRADE PLAN â•â•â•**\n**'+$.sym.sh+'** '+TFS.find(t=>t.v===$.tf)?.l+' '+($.dataLive?'ğŸ“¡':'âš ï¸')+'\nPrice: **'+Pc(px)+'**\n\n';
  p+='**ğŸ“ STRUCTURE:** '+(A.bias==='Bullish'?'__'+A.bias+'__':A.bias==='Bearish'?'~~'+A.bias+'~~':A.bias)+' '+A.conf+'%\n'+A.str+'\n';
  if(A.bos)p+='BOS: '+A.bos.ty+' at '+Pc(A.bos.lv)+'\n';
  if(A.choch)p+='CHoCH: '+A.choch.ty+' at '+Pc(A.choch.lv)+'\n';
  p+='\n**ğŸ” PATTERNS**\n';
  if(A.fvgs.length)p+='ğŸ“Š FVGs: '+A.fvgs.slice(-3).map(f=>(f.ty==='bull'?'ğŸŸ¢':'ğŸ”´')+' '+Pc(f.bot)+'â€“'+Pc(f.top)).join(' | ')+'\n';
  if(A.obs.length)p+='ğŸ§± OBs: '+A.obs.slice(-2).map(o=>(o.ty==='bull'?'ğŸŸ¢':'ğŸ”´')+' '+Pc(o.lo)+'â€“'+Pc(o.hi)).join(' | ')+'\n';
  if(A.brk.length)p+='ğŸ” Breakers: '+A.brk.slice(-2).map(b=>Pc(b.lo)+'â€“'+Pc(b.hi)+(b.touch?' TOUCH':'')).join(' | ')+'\n';
  if(A.sweeps.length)p+='ğŸ’§ Sweeps: '+A.sweeps.map(s=>s.ty+' at '+Pc(s.lv)).join(' | ')+'\n';
  if(A.disp)p+='âš¡ Disp: '+A.disp.d+' '+A.disp.n+'x\n';
  if(A.mmbm)p+='ğŸ“ˆ **MMBM** SSLâ†’'+Pc(A.mmbm.sw)+' tgt '+Pc(A.mmbm.tgt)+'\n';
  if(A.mmsm)p+='ğŸ“‰ **MMSM** BSLâ†’'+Pc(A.mmsm.sw)+' tgt '+Pc(A.mmsm.tgt)+'\n';
  if(fi)p+='\nğŸ“ **Fib:** '+Pc(fi.sH)+'â†’'+Pc(fi.sL)+' '+fi.pct+'%'+(fi.inOTE?' ^^OTE^^':'')+'\n';
  if(A.pd)p+='ğŸ’° '+(A.pd.zone==='discount'?'__DISCOUNT__':'~~PREMIUM~~')+' ('+A.pd.pct+'%)\n';
  p+='ğŸ• '+se.n+' '+se.p+(se.kz?' ^^KZ^^':'')+(se.sb?' ^^SB^^':'')+'\n\n';
  if(A.trade){
    const t=A.trade;
    p+='**â•â•â• SETUP â•â•â•**\n'+(t.dir==='LONG'?'__ğŸŸ¢ LONG__':'~~ğŸ”´ SHORT~~')+' | **'+t.mdl+'**\n';
    p+='Entry: ^^'+t.ent+'^^ ('+t.eR+')\nSL: ~~'+t.sl+'~~ ('+t.slR+')\nTP1: __'+t.tp1+'__ | TP2: __'+t.tp2+'__ | R:R '+t.rr+'\n\n';
    p+='**ğŸ“‹ CONFLUENCE**\n';
    p+=(A.sweeps.length?'âœ…':'âŒ')+' Sweep'+(A.sweeps.length?' ('+A.sweeps[A.sweeps.length-1].ty+' '+Pc(A.sweeps[A.sweeps.length-1].lv)+')':'')+'\n';
    p+=(A.disp?'âœ…':'âŒ')+' Displacement'+(A.disp?' ('+A.disp.d+' '+A.disp.n+'x)':'')+'\n';
    p+=(A.fvgs.length?'âœ…':'âŒ')+' FVG'+(A.fvgs.length?' ('+A.fvgs.length+')':'')+'\n';
    p+=(A.obs.length?'âœ…':'âŒ')+' OB\n';
    p+=(fi?.inOTE?'âœ…':'âŒ')+' OTE'+(fi?' ('+fi.pct+'%)':'')+'\n';
    p+=(se.kz?'âœ…':'âš ï¸')+' KZ ('+se.n+')\n\n';
    p+='**ğŸ’¡ WHY:** ';
    if(A.mmbm)p+='MMBM active â€” SSL swept, bull disp, targeting BSL. ';
    else if(A.mmsm)p+='MMSM active â€” BSL swept, bear disp, targeting SSL. ';
    else if(A.sweeps.length&&A.disp)p+='Sweepâ†’displacement = manipulationâ†’expansion. ';
    if(A.fvgs.length)p+='FVG at '+Pc(A.fvgs[A.fvgs.length-1].bot)+'â€“'+Pc(A.fvgs[A.fvgs.length-1].top)+' for entry. ';
    if(fi?.inOTE)p+='In OTE ('+fi.pct+'%). ';
  }else{
    p+='**â•â•â• NO TRADE â•â•â•**\n';
    if(!A.sweeps.length)p+='âŒ No sweep\n';if(!A.disp)p+='âŒ No displacement\n';
    if(!A.fvgs.length&&!A.obs.length)p+='âŒ No FVG/OB\n';
    p+='\n**Wait:** Sweepâ†’Displacementâ†’FVGâ†’OTEâ†’KZ';
  }
  return p;
}

function bldEntry(){
  const A=$.ict,fi=$.fib,px=nowPrice(),se=getSess();
  if(!A)return'âš ï¸ No data.';
  const ch=[A.sweeps.length>0,!!A.disp,A.fvgs.length>0||A.obs.length>0,fi?.inOTE,se.kz,A.bias!=='Neutral'];
  const sc=ch.filter(Boolean).length;
  let r='**Enter '+$.sym.sh+'?** '+Pc(px)+' | '+A.bias+' '+A.conf+'%\n\n';
  r+=(ch[0]?'âœ…':'âŒ')+' Sweep\n'+(ch[1]?'âœ…':'âŒ')+' Disp\n'+(ch[2]?'âœ…':'âŒ')+' FVG/OB\n'+(ch[3]?'âœ…':'âŒ')+' OTE\n'+(ch[4]?'âœ…':'âš ï¸')+' KZ\n'+(ch[5]?'âœ…':'âŒ')+' Bias\n\n**'+sc+'/6** â€” ';
  if(sc>=5&&A.trade)r+='**^^YES^^** '+A.trade.dir+' @ '+A.trade.ent+' SL ~~'+A.trade.sl+'~~ TP __'+A.trade.tp1+'__/__'+A.trade.tp2+'__ '+A.trade.rr;
  else if(sc>=4)r+='**^^CAUTIOUS^^** '+(A.trade?A.trade.dir+' @ '+A.trade.ent:'');
  else if(sc>=3)r+='**âš ï¸ WAIT** developing';
  else r+='**~~NO~~** '+sc+'/6';
  return r;
}

function bldReply(m){
  const A=$.ict,fi=$.fib,px=nowPrice();
  if(m.includes('bias')||m.includes('trend'))return A?'**'+A.bias+'** '+A.conf+'% '+A.str+(A.mmbm?' __MMBM__':'')+(A.mmsm?' ~~MMSM~~':''):'No data.';
  if(m.includes('fvg')||m.includes('fair value'))return A?.fvgs.length?'ğŸ“Š '+A.fvgs.slice(-4).map(f=>(f.ty==='bull'?'ğŸŸ¢':'ğŸ”´')+' '+Pc(f.bot)+'â€“'+Pc(f.top)+' CE:'+Pc(f.mid)).join(' | '):'No FVGs.';
  if(m.match(/\bob\b/)||m.includes('order block'))return A?.obs.length?'ğŸ§± '+A.obs.slice(-3).map(o=>(o.ty==='bull'?'ğŸŸ¢':'ğŸ”´')+' '+Pc(o.lo)+'â€“'+Pc(o.hi)).join(' | '):'No OBs.';
  if(m.includes('breaker'))return A?.brk.length?'ğŸ” '+A.brk.slice(-2).map(b=>Pc(b.lo)+'â€“'+Pc(b.hi)+(b.touch?' TOUCH':'')).join(' | '):'No breakers.';
  if(m.includes('sweep')||m.includes('liquid'))return A?.sweeps.length?'ğŸ’§ '+A.sweeps.map(s=>s.ty+' '+Pc(s.lv)+' wk:'+Pc(s.wk)).join(' | '):'No sweeps.';
  if(m.includes('mmbm'))return A?.mmbm?'ğŸ“ˆ **MMBM:** SSL swept '+Pc(A.mmbm.sw)+' â†’ Target '+Pc(A.mmbm.tgt):A?.mmsm?'ğŸ“‰ **MMSM:** BSL swept '+Pc(A.mmsm.sw)+' â†’ Target '+Pc(A.mmsm.tgt):'No MMBM/MMSM active.';
  if(m.includes('fib')||m.includes('retracement')){showFib();return fi?'ğŸ“ '+Pc(fi.sH)+'â†’'+Pc(fi.sL)+' '+fi.pct+'%'+(fi.inOTE?' ^^OTE^^':''):'No fib.'}
  if(m.includes('session')||m.includes('kz')){const s=getSess();return'ğŸ• **'+s.n+'** '+s.p+(s.kz?' ^^KZ^^':'')+(s.sb?' ^^SB^^':'')}
  if(m.includes('price'))return'ğŸ’µ **'+$.sym.sh+':** '+Pc(px)+' '+($.dataLive?'ğŸ“¡':'âš ï¸');
  if(m.includes('track')){let r='**ğŸ“‹ ICT ENTRY TRACKS**\n\n';for(const[n,d]of Object.entries(TRACKS))r+='**'+n+':** '+d+'\n';return r}
  // KB lookup
  for(const[k,v]of Object.entries(KB)){if(k.toLowerCase().split(/[\s/()]+/).filter(w=>w.length>1).some(w=>m.includes(w.toLowerCase())))return'**'+k+'**\n'+v+'\n\nğŸ’¡ Ask: trade plan, enter?, bias, FVG, OB, breaker, tracks'}
  return'ğŸ¤– **100+ ICT Concepts Ready**\nAsk: trade plan, enter?, bias, FVG, OB, breaker, sweep, MMBM, fib, session, price, tracks\nOr ask about: '+Object.keys(KB).slice(0,15).join(', ')+'...';
}

function rKB(b){
  const cats=[
    {n:'STRUCTURE',ks:['BOS','CHoCH','MSS','MSB','HH','HL','LH','LL','Swing High','Swing Low','CISD']},
    {n:'PRICE DELIVERY',ks:['FVG','IFVG','Implied FVG','Micro FVG','OB','Extreme OB','High Prob OB','Breaker Block','Mitigation Block','VI','BPR','CE','Mean Threshold']},
    {n:'LIQUIDITY',ks:['BSL','SSL','Internal Liq','External Liq','Liq Void','Liq Pool','Liq Grab','EQH','EQL','Stop Hunt','Inducement','Trendline Liq','DOL']},
    {n:'MODELS',ks:['MMBM','MMSM','MMXM','PO3','Silver Bullet','Turtle Soup','Quasimodo','RBD','DBR','Asian Trifecta']},
    {n:'ZONES',ks:['OTE','Golden OTE','PD','PD Array','KZ','Displacement','Anchoring','NDOG','Fresh Zone','Nested PD','HTF','MTF']},
    {n:'TRACKS',ks:Object.keys(TRACKS)}
  ];
  b.innerHTML=cats.map(c=>`<div style="margin-bottom:6px"><div style="font-size:7px;font-weight:700;color:var(--accent);margin-bottom:2px">${c.n} (${c.ks.length})</div>${c.ks.map(k=>`<div class="kbi hover-row" onclick="$.tab='chat';sendC('Explain ${k.replace(/'/g,"\\'")}')"><span style="font-size:5px">${c.n==='TRACKS'?'ğŸ¯':'ğŸ“˜'}</span>${k}</div>`).join('')}</div>`).join('');
}

// â•â•â• STATUS â•â•â•
function updSt(){
  const est=new Date().toLocaleTimeString('en-US',{timeZone:'America/New_York',hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const s=getSess();
  const age=$.lastFetchMs?Math.round((Date.now()-$.lastFetchMs)/1000):99;
  const fresh=age<15;
  document.getElementById('stl').innerHTML='SMC v8 â€¢ '+($.dataLive?'<span style="color:var(--green)">ğŸ“¡ LIVE</span>':'<span style="color:var(--red)">âš  OFFLINE</span>')+' â€¢ '+$.sym.sh+'/'+TFS.find(t=>t.v===$.tf)?.l+' â€¢ '+$.candles.length+'c â€¢ <span style="color:var(--text1)">'+Pc(nowPrice())+'</span> ['+$.pxSrc+'] <span style="color:'+(fresh?'var(--green)':'var(--yellow)')+'">('+(fresh?'live':age+'s')+')</span>';
  document.getElementById('str').innerHTML=s.i+' '+s.n+' â€¢ '+est+' EST';
  rSess();updPx();
}

// â•â•â• INIT â•â•â•
document.addEventListener('click',e=>{if(!document.getElementById('symw').contains(e.target))document.getElementById('sdrop').classList.remove('open')});
rTF();rSess();loadChart();rP();updSt();
setInterval(updSt,5000);
startWatch();
</script>
</body>
</html>
